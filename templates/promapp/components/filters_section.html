{% load i18n %}
{% load static %}

<!-- Filters Section -->
<div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="p-4 border-b border-gray-200">
        <button 
            class="w-full flex items-center justify-between text-left group hover:bg-gray-50 -m-2 p-2 rounded-lg transition-colors duration-200"
            onclick="toggleFilters()"
        >
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-gray-900">{% translate "Filters" %}</h3>
                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">{% translate "Click to expand" %}</span>
            </div>
            <div class="flex items-center gap-2">
                <div id="filters-loading" class="htmx-indicator">
                    <svg class="animate-spin h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <svg id="filters-chevron" class="w-5 h-5 text-gray-500 transform transition-transform duration-200 rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </button>
    </div>
    
    <div id="filters-content" class="hidden">
        <form id="filters-form" class="p-4 space-y-6">
            <!-- Time Analysis Filters Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Start Date Reference -->
                <div>
                    <label for="start-date-reference" class="block text-sm font-medium text-gray-700 mb-1">
                        {% translate "Start Date Reference" %}
                    </label>
                    <select 
                        id="start-date-reference" 
                        name="start_date_reference"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        {% for ref_key, display_name, date_value in available_start_dates %}
                        <option value="{{ ref_key }}" {% if request.GET.start_date_reference == ref_key or not request.GET.start_date_reference and forloop.first %}selected{% endif %}>
                            {{ display_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Relative Time Filter -->
                <div>
                    <label for="max-time-interval" class="block text-sm font-medium text-gray-700 mb-1">
                        {% translate "Up to" %} <span id="time-interval-unit-display">{% translate "weeks" %}</span> {% translate "after start date" %}
                    </label>
                    <input 
                        type="number" 
                        id="max-time-interval" 
                        name="max_time_interval"
                        value="{{ request.GET.max_time_interval }}"
                        min="0"
                        step="0.1"
                        placeholder="{% translate 'All data' %}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>

                <!-- Time Range Filter -->
                <div>
                    <label for="time-range" class="block text-sm font-medium text-gray-700 mb-1">
                        {% translate "Time Range" %}
                    </label>
                    <select 
                        id="time-range" 
                        name="time_range"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="3" {% if request.GET.time_range == "3" %}selected{% endif %}>{% translate "3 submissions" %}</option>
                        <option value="5" {% if request.GET.time_range == "5" or not request.GET.time_range %}selected{% endif %}>{% translate "5 submissions" %}</option>
                        <option value="10" {% if request.GET.time_range == "10" %}selected{% endif %}>{% translate "10 submissions" %}</option>
                        <option value="15" {% if request.GET.time_range == "15" %}selected{% endif %}>{% translate "15 submissions" %}</option>
                        <option value="all" {% if request.GET.time_range == "all" %}selected{% endif %}>{% translate "All submissions" %}</option>
                    </select>
                </div>

                <!-- Time Interval -->
                <div>
                    <label for="time-interval" class="block text-sm font-medium text-gray-700 mb-1">
                        {% translate "Time Interval" %}
                    </label>
                    <select 
                        id="time-interval" 
                        name="time_interval"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
onchange="updateTimeIntervalDisplay()"
                    >
                        <option value="days" {% if request.GET.time_interval == "days" %}selected{% endif %}>{% translate "Days" %}</option>
                        <option value="weeks" {% if request.GET.time_interval == "weeks" or not request.GET.time_interval %}selected{% endif %}>{% translate "Weeks" %}</option>
                        <option value="months" {% if request.GET.time_interval == "months" %}selected{% endif %}>{% translate "Months" %}</option>
                        <option value="years" {% if request.GET.time_interval == "years" %}selected{% endif %}>{% translate "Years" %}</option>
                    </select>
                </div>
            </div>

            <!-- Population Comparison Filters Row -->
            <div class="pt-4 border-t border-gray-100">
                <h4 class="text-sm font-medium text-gray-900 mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.196-2.044M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 515.196-2.044M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    {% translate "Population Comparison Filters" %}
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Aggregation Type -->
                    <div>
                        <label for="aggregation-type" class="block text-sm font-medium text-gray-700 mb-1">
                            {% translate "Aggregation Type" %}
                        </label>
                        <select 
                            id="aggregation-type" 
                            name="aggregation_type"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="median_iqr" {% if request.GET.aggregation_type == "median_iqr" or not request.GET.aggregation_type %}selected{% endif %}>{% translate "Median with IQR (25th-75th percentile)" %}</option>
                            <option value="mean_95ci" {% if request.GET.aggregation_type == "mean_95ci" %}selected{% endif %}>{% translate "Mean with 95% Confidence Interval" %}</option>
                            <option value="mean_0.5sd" {% if request.GET.aggregation_type == "mean_0.5sd" %}selected{% endif %}>{% translate "Mean ± 0.5 Standard Deviation" %}</option>
                            <option value="mean_1sd" {% if request.GET.aggregation_type == "mean_1sd" %}selected{% endif %}>{% translate "Mean ± 1 Standard Deviation" %}</option>
                            <option value="mean_2sd" {% if request.GET.aggregation_type == "mean_2sd" %}selected{% endif %}>{% translate "Mean ± 2 Standard Deviations" %}</option>
                        </select>
                    </div>

                    <!-- Gender Filter -->
                    <div>
                        <label for="patient-filter-gender" class="block text-sm font-medium text-gray-700 mb-1">
                            {% translate "Gender Filter" %}
                        </label>
                        <select 
                            id="patient-filter-gender" 
                            name="patient_filter_gender"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="">{% translate "All Genders" %}</option>
                            <option value="match" {% if request.GET.patient_filter_gender == "match" %}selected{% endif %}>{% translate "Match Patient" %} ({{ patient.gender }})</option>
                            <option value="Male" {% if request.GET.patient_filter_gender == "Male" %}selected{% endif %}>{% translate "Male" %}</option>
                            <option value="Female" {% if request.GET.patient_filter_gender == "Female" %}selected{% endif %}>{% translate "Female" %}</option>
                            <option value="Other" {% if request.GET.patient_filter_gender == "Other" %}selected{% endif %}>{% translate "Other" %}</option>
                        </select>
                    </div>

                    <!-- Diagnosis Filter -->
                    <div>
                        <label for="patient-filter-diagnosis" class="block text-sm font-medium text-gray-700 mb-1">
                            {% translate "Diagnosis Filter" %}
                        </label>
                        <select 
                            id="patient-filter-diagnosis" 
                            name="patient_filter_diagnosis"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="">{% translate "All Diagnoses" %}</option>
                            <option value="match" {% if request.GET.patient_filter_diagnosis == "match" %}selected{% endif %}>{% translate "Match Patient" %}</option>
                            {% for diagnosis in available_diagnoses %}
                            <option value="{{ diagnosis.id }}" {% if request.GET.patient_filter_diagnosis == diagnosis.id|stringformat:"s" %}selected{% endif %}>
                                {{ diagnosis.diagnosis }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Treatment Filter -->
                    <div>
                        <label for="patient-filter-treatment" class="block text-sm font-medium text-gray-700 mb-1">
                            {% translate "Treatment Filter" %}
                        </label>
                        <select 
                            id="patient-filter-treatment" 
                            name="patient_filter_treatment"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="">{% translate "All Treatments" %}</option>
                            <option value="match" {% if request.GET.patient_filter_treatment == "match" %}selected{% endif %}>{% translate "Match Patient" %}</option>
                            {% for treatment_type in available_treatment_types %}
                            <option value="{{ treatment_type.id }}" {% if request.GET.patient_filter_treatment == treatment_type.id|stringformat:"s" %}selected{% endif %}>
                                {{ treatment_type.treatment_type }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Age Range Filters -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="patient-filter-min-age" class="block text-sm font-medium text-gray-700 mb-1">
                            {% translate "Minimum Age" %}
                        </label>
                        <input 
                            type="number" 
                            id="patient-filter-min-age" 
                            name="patient_filter_min_age"
                            value="{{ request.GET.patient_filter_min_age }}"
                            min="0"
                            max="150"
                            placeholder="{% translate 'No limit' %}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>
                    <div>
                        <label for="patient-filter-max-age" class="block text-sm font-medium text-gray-700 mb-1">
                            {% translate "Maximum Age" %}
                        </label>
                        <input 
                            type="number" 
                            id="patient-filter-max-age" 
                            name="patient_filter_max_age"
                            value="{{ request.GET.patient_filter_max_age }}"
                            min="0"
                            max="150"
                            placeholder="{% translate 'No limit' %}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>
                </div>
            </div>

            <!-- Submit and Reset Buttons -->
            <div class="pt-4 border-t border-gray-100 flex items-center justify-between">
                <button 
                    type="button"
                    id="reset-filters-btn"
                    onclick="resetFilters()"
                    class="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200"
                >
                    <svg class="inline-block w-4 h-4 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    {% translate "Reset Filters" %}
                </button>
                
                <button 
                    type="submit"
                    id="submit-filters-btn"
                    class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
                >
                    <svg class="inline-block w-4 h-4 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    {% translate "Apply Filters" %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Filter Calculation Loader -->
<div id="filter-loader" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm mx-4">
        <div class="flex flex-col items-center">
            <!-- Spinner -->
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-4"></div>
            <!-- Loading text -->
            <h3 class="text-lg font-semibold text-gray-900 mb-2">{% translate "Applying Filters" %}</h3>
            <p class="text-sm text-gray-600 text-center">{% translate "Recalculating patient responses and aggregated data..." %}</p>
        </div>
    </div>
</div>

<script>
// Patient age data
var PATIENT_AGE = {% if patient_current_age %}{{ patient_current_age }}{% else %}null{% endif %};

// Item filter functionality is handled in prom_review.html

function updateTimeIntervalDisplay() {
    const timeIntervalSelect = document.getElementById('time-interval');
    const displayElement = document.getElementById('time-interval-unit-display');
    
    if (timeIntervalSelect && displayElement) {
        const selectedValue = timeIntervalSelect.value;
        const unitNames = {
            'days': '{% translate "days" %}',
            'weeks': '{% translate "weeks" %}',
            'months': '{% translate "months" %}',
            'years': '{% translate "years" %}'
        };
        displayElement.textContent = unitNames[selectedValue] || '{% translate "weeks" %}';
    }
}

// Item filter update functionality is handled in prom_review.html

// Age filter helper function
function matchPatientAge() {
    if (PATIENT_AGE !== null) {
        var minAgeInput = document.getElementById('patient-filter-min-age');
        var maxAgeInput = document.getElementById('patient-filter-max-age');
        
        if (minAgeInput && maxAgeInput) {
            minAgeInput.value = PATIENT_AGE;
            maxAgeInput.value = PATIENT_AGE;
            
            // Trigger HTMX update
            minAgeInput.dispatchEvent(new Event('change'));
        }
    } else {
        console.log('Patient age not available');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateItemDisplayText();
    updateTimeIntervalDisplay();
    
    // Handle form submission
    const filtersForm = document.getElementById('filters-form');
    if (filtersForm) {
        filtersForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitFilters();
        });
    }
});

// Function to submit filters with loader
function submitFilters() {
    const form = document.getElementById('filters-form');
    const loader = document.getElementById('filter-loader');
    
    if (!form) return;
    
    // Show loader
    if (loader) {
        loader.style.display = 'flex';
    }
    
    // Collect all form data including hidden item filter inputs
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    // Add all form fields to params
    for (let [key, value] of formData.entries()) {
        if (value && value.trim() !== '') {
            params.append(key, value);
        }
    }
    
    // Build URL with parameters
    const url = "{% url 'prom_review' patient.id %}" + '?' + params.toString();
    
    // Make HTMX request
    htmx.ajax('GET', url, {
        target: '#filterable-content',
        swap: 'innerHTML'
    }).then(function() {
        // Hide loader after content is loaded
        if (loader) {
            setTimeout(function() {
                loader.style.opacity = '0';
                loader.style.transition = 'opacity 0.3s ease-out';
                setTimeout(function() {
                    loader.style.display = 'none';
                    loader.style.opacity = '1';
                }, 300);
            }, 100);
        }
    }).catch(function() {
        // Hide loader on error
        if (loader) {
            loader.style.display = 'none';
        }
    });
}

// Function to reset filters
function resetFilters() {
    // Reload page without query parameters
    window.location.href = "{% url 'prom_review' patient.id %}";
}
</script> 