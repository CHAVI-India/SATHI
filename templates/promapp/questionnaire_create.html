{% extends 'base.html' %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}{% trans "Create Questionnaire" %}{% endblock %}

{% block extra_css %}
<style>
  .item-list {
    max-height: 500px;
    overflow-y: auto;
  }
  .construct-scale-header {
    position: sticky;
    top: 0;
    background-color: #f3f4f6;
    z-index: 10;
  }
  .question-number {
    width: 60px;
    text-align: center;
  }
  .filtered-out {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="bg-white shadow-md rounded-lg overflow-hidden">
    <div class="p-6">
      <h1 class="text-2xl font-bold text-blue-700 mb-6">{% trans "Create New Questionnaire" %}</h1>
      
      <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <div class="bg-gray-50 p-4 rounded-md">
          <h2 class="text-lg font-semibold text-gray-800 mb-4">{% trans "Questionnaire Details" %}</h2>
          {{ form|crispy }}
        </div>
        
        <div class="bg-gray-50 p-4 rounded-md">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-800">{% trans "Select Items" %}</h2>
            <a href="{% url 'item_create' %}" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 inline-flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
              </svg>
              {% trans "Create New Item" %}
            </a>
          </div>
          
          <!-- Search and Filter controls -->
          <div class="mb-4 flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
            <div class="flex-1">
              <label for="item-search" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Search items" %}</label>
              <input type="text" id="item-search" class="w-full px-3 py-2 border rounded" placeholder="{% trans 'Search by name...' %}" aria-label="{% trans 'Search items' %}">
            </div>
            <div class="w-full md:w-64">
              <label for="construct-filter" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Filter by construct scale" %}</label>
              <select id="construct-filter" class="w-full px-3 py-2 border rounded">
                <option value="all">{% trans "All construct scales" %}</option>
                {% for construct_scale in construct_scales %}
                  <option value="{{ construct_scale.id }}">{{ construct_scale.name|default:"No name" }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          
          {% if available_items %}
            <div class="item-list">
              {% regroup available_items by construct_scale as items_by_scale %}
              
              {% for scale_group in items_by_scale %}
                <div class="mb-6 scale-group" data-scale-id="{{ scale_group.grouper.id|default:'none' }}">
                  <div class="construct-scale-header p-2 mb-2 bg-blue-100 rounded">
                    <h3 class="font-medium">
                      {{ scale_group.grouper.name|default:"No Construct Scale" }}
                      {% if scale_group.grouper.instrument_name %}
                        <span class="text-sm text-gray-600 ml-2">({{ scale_group.grouper.instrument_name }}{% if scale_group.grouper.instrument_version %} v{{ scale_group.grouper.instrument_version }}{% endif %})</span>
                      {% endif %}
                    </h3>
                  </div>
                  
                  <div class="pl-4 space-y-2">
                    {% for item in scale_group.list %}
                      <div class="flex items-start p-2 hover:bg-gray-50 rounded item-row" data-item-name="{{ item.name|default:'Untitled Item'|lower }}" data-scale-id="{{ item.construct_scale.id|default:'none' }}">
                        <input type="checkbox" 
                               name="items" 
                               value="{{ item.id }}" 
                               id="item_{{ item.id }}" 
                               class="mt-1 mr-3">
                        <div class="flex-shrink-0 mr-3">
                          <label for="question_number_{{ item.id }}" class="sr-only">{% trans "Question Number" %}</label>
                          <input type="number" 
                                 name="question_number_{{ item.id }}" 
                                 id="question_number_{{ item.id }}" 
                                 class="question-number form-control border rounded px-2 py-1"
                                 min="1"
                                 placeholder="#"
                                 disabled>
                        </div>
                        <label for="item_{{ item.id }}" class="cursor-pointer flex-1">
                          <div class="font-medium">{{ item.name|default:"Untitled Item" }}</div>
                          <div class="text-sm text-gray-600">
                            {% trans "Response type" %}: {{ item.get_response_type_display }}
                            {% if item.response_type == 'Likert' and item.likert_response %}
                              - {{ item.likert_response.likert_scale_name }}
                            {% elif item.response_type == 'Range' and item.range_response %}
                              - {{ item.range_response.range_scale_name }}
                            {% endif %}
                          </div>
                        </label>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-8">
              <p class="text-gray-600 mb-4">{% trans "No items available. Please create items first." %}</p>
              <a href="{% url 'item_create' %}" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 inline-flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                {% trans "Create First Item" %}
              </a>
            </div>
          {% endif %}
        </div>
        
        <div class="flex justify-end space-x-3">
          <a href="{% url 'questionnaire_list' %}" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
            {% trans "Cancel" %}
          </a>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            {% trans "Create Questionnaire" %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[name="items"]');
    const searchInput = document.getElementById('item-search');
    const constructFilter = document.getElementById('construct-filter');
    
    // Handle checkbox changes to enable/disable question number inputs
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const itemId = this.value;
        const questionNumberInput = document.getElementById(`question_number_${itemId}`);
        
        if (this.checked) {
          questionNumberInput.disabled = false;
        } else {
          questionNumberInput.disabled = true;
          questionNumberInput.value = '';
        }
      });
    });
    
    // Handle search input
    searchInput.addEventListener('input', filterItems);
    
    // Handle construct scale filter
    constructFilter.addEventListener('change', filterItems);
    
    // Combined filter function
    function filterItems() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const selectedScale = constructFilter.value;
      
      // Get all item rows
      const itemRows = document.querySelectorAll('.item-row');
      const scaleGroups = document.querySelectorAll('.scale-group');
      
      // Track which scale groups have visible items
      const scaleVisibility = {};
      
      // Process each item
      itemRows.forEach(row => {
        const itemName = row.getAttribute('data-item-name');
        const scaleId = row.getAttribute('data-scale-id');
        const scaleVisible = scaleVisibility[scaleId] || false;
        
        // Check if item matches search term and scale filter
        const matchesSearch = !searchTerm || itemName.includes(searchTerm);
        const matchesScale = selectedScale === 'all' || selectedScale === scaleId;
        
        // Show/hide the item based on filters
        if (matchesSearch && matchesScale) {
          row.classList.remove('filtered-out');
          scaleVisibility[scaleId] = true;
        } else {
          row.classList.add('filtered-out');
          // Only update if not already visible from another item
          if (!scaleVisible) {
            scaleVisibility[scaleId] = false;
          }
        }
      });
      
      // Show/hide scale groups based on whether they have visible items
      scaleGroups.forEach(group => {
        const scaleId = group.getAttribute('data-scale-id');
        if (scaleVisibility[scaleId] || selectedScale === 'all' && !searchTerm) {
          group.classList.remove('filtered-out');
        } else {
          group.classList.add('filtered-out');
        }
      });
    }
  });
</script>
{% endblock %}
{% endblock %} 