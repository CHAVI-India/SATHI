{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load cotton %}

{% block title %}{% translate "Patient Questionnaires" %}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <div class="bg-white shadow-md rounded-lg overflow-hidden">
    <!-- Header -->
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">
            {% translate "Patient Questionnaires" %}
          </h1>
          <p class="mt-1 text-sm text-gray-600">
            {% translate "Manage questionnaires assigned to patients" %}
          </p>
        </div>
        <div class="flex space-x-3">
          {% if perms.patientapp.add_patient %}
          <c-create_button href="{% url 'patient_create' %}">
            {% translate "Add Patient" %}
          </c-create_button>
          {% endif %}
          {% if perms.promapp.add_questionnaire %}
          <c-create_button href="{% url 'questionnaire_create' %}" variant="primary">
            {% translate "Create Questionnaire" %}
          </c-create_button>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
      <div class="mb-2">
        <span class="text-sm font-semibold text-gray-700">{% translate "Search & Filter" %}</span>
      </div>
      <form method="get">
        <div class="flex flex-wrap gap-4 items-end">
          <!-- Search Box -->
          <div class="w-64">
            <label for="search" class="block text-sm font-medium text-gray-700">{% translate "Search" %}</label>
            <div class="relative mt-1">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
              </div>
              <input type="text" name="search" id="search" value="{{ request.GET.search }}" 
                     class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                     placeholder="{% translate 'Search by exact name or ID...' %}">
            </div>
          </div>

          <!-- Questionnaire Count Filter -->
          <c-filter_dropdown 
            name="questionnaire_count" 
            label="{% translate 'Questionnaires' %}"
            placeholder="{% translate 'All' %}"
            :options="questionnaire_count_choices"
            :selected="request.GET.questionnaire_count" />

          <!-- Sort Order -->
          <c-filter_dropdown 
            name="sort" 
            label="{% translate 'Sort By' %}"
            placeholder="{% translate 'Name' %}"
            :options="sort_choices"
            :selected="request.GET.sort" />

          <!-- Filter Buttons -->
          <div class="flex items-end space-x-2">
            <c-button type="submit" variant="primary">
              {% translate "Apply Filters" %}
            </c-button>
            <c-link_button href="{% url 'patient_questionnaire_list' %}" variant="secondary">
              {% translate "Clear" %}
            </c-link_button>
          </div>
        </div>
      </form>
    </div>

    <!-- Messages -->
    {% if messages %}
      <div class="px-6 py-4">
        {% for message in messages %}
          <div class="{% if message.tags == 'error' %}bg-red-100 border-red-400 text-red-700{% elif message.tags == 'success' %}bg-green-100 border-green-400 text-green-700{% else %}bg-blue-100 border-blue-400 text-blue-700{% endif %} px-4 py-3 mb-3 rounded border" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Patients List -->
    <div class="px-6 py-4">
      <!-- Check for empty state -->
      <c-list_card :items="patients" empty_message="{% translate 'No patients found.' %}" />

      <!-- Manual iteration for each patient card -->
      <div class="space-y-4">
        {% for patient in patients %}
        <c-card 
          shadow="sm" 
          border="light" 
          padding="md" 
          class="w-full hover:shadow-md transition-shadow duration-200">
          
          <!-- Patient card content -->
          <div class="space-y-4">
            <!-- Top row: Patient info and action buttons -->
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3">
              <!-- Left side: Patient info -->
              <div class="flex-1 min-w-0">
                <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                  <div class="flex-1 min-w-0">
                    <h3 class="text-lg font-medium text-gray-900 truncate">{{ patient.name }}</h3>
                    <p class="text-sm text-gray-600">ID: {{ patient.patient_id }}</p>
                  </div>
                  <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6 text-sm text-gray-600">
                    <span>Age: {{ patient.age|default:"â€”" }}</span>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 w-fit">
                      {{ patient.gender|default:"â€”" }}
                    </span>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 w-fit">
                      {{ patient.questionnaire_count }} {% translate "questionnaires" %}
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- Right side: Action buttons -->
              <div class="flex space-x-2 sm:flex-shrink-0">
                <c-view_button href="{% url 'patient_detail' patient.id %}" size="sm">
                  {% translate "View Patient" %}
                </c-view_button>
                <c-link_button href="{% url 'patient_questionnaire_management' patient.id %}" variant="success" size="sm">
                  {% translate "Manage Questionnaires" %}
                </c-link_button>
              </div>
            </div>
            
            <!-- Bottom row: Questionnaire details -->
            <div class="pt-3 border-t border-gray-100">
              <h4 class="text-sm font-medium text-gray-700 mb-2">{% translate "Assigned Questionnaires" %}</h4>
              {% if patient.questionnaire_names %}
                <div class="flex flex-wrap gap-1">
                  {% for qname in patient.questionnaire_names %}
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                    {{ qname }}
                  </span>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-sm text-gray-500 italic">{% translate "No questionnaires assigned" %}</p>
              {% endif %}
            </div>
          </div>
        </c-card>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if is_paginated %}
      <div class="mt-6">
        <c-paginator 
          :page_obj="page_obj" 
          :is_paginated="is_paginated" 
          show_info="true"
          show_page_numbers="true" />
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %} 