{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% translate "Questionnaire Response" %} - {{ patient_questionnaire.questionnaire.name }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-8">
  <div class="bg-white shadow rounded-lg p-6">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ patient_questionnaire.questionnaire.name }}</h1>
      {% if patient_questionnaire.questionnaire.description %}
        <p class="text-gray-600">{{ patient_questionnaire.questionnaire.description }}</p>
      {% endif %}
      <div class="mt-4">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-600">
            <span id="current-question-number">1</span> {% translate "of" %} <span id="total-questions">{{ items_with_translations|length }}</span>
          </div>
        </div>
        <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
          <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Messages -->
    {% if messages %}
      <div class="mb-6">
        {% for message in messages %}
          <div class="{% if message.tags == 'error' %}bg-red-100 border-red-400 text-red-700{% elif message.tags == 'success' %}bg-green-100 border-green-400 text-green-700{% else %}bg-blue-100 border-blue-400 text-blue-700{% endif %} px-4 py-3 rounded border" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Questionnaire Form -->
    {% if not can_answer %}
    <div class="alert alert-warning">
        {% blocktrans %}You cannot answer this questionnaire yet. You can answer it again in {{ next_available|timeuntil }}.{% endblocktrans %}
    </div>
    {% endif %}
    <form method="post" id="questionnaire-form" class="space-y-8" {% if not can_answer %}disabled{% endif %}>
      {% csrf_token %}
      
      {% for item_data in items_with_translations %}
        {% with qi=item_data.questionnaire_item %}
        <div class="question-item bg-gray-50 p-6 rounded-lg {% if not forloop.first %}hidden{% endif %} transition-opacity duration-300 ease-in-out" 
             data-question-number="{{ qi.question_number }}"
             data-question-id="{{ qi.id }}"
             data-rules="{{ qi.visibility_rules.all|length }}"
             data-rule-groups="{{ qi.rule_groups.all|length }}">
          
          <div class="flex items-start mb-4">
            <div class="question-number-display font-bold mr-4 w-8 h-8 rounded-full bg-blue-100 flex-shrink-0 flex items-center justify-center">
              {{ qi.question_number }}
            </div>
            <div class="flex-1">
              <h3 class="text-xl font-medium text-gray-900 mb-4">
                {% with item_name=qi.item.name %}
                  {% if item_name %}
                    {{ item_name }}
                  {% else %}
                    {% with item=qi.item %}
                      {% with item_translation=item.translations.language %}
                        {% if item_translation %}
                          {{ item_translation.name }}
                        {% else %}
                          {% with en_translation=item.translations.language %}
                            {% if en_translation %}
                              {{ en_translation.name }}
                            {% else %}
                              {{ item.translations.all.0.name }}
                            {% endif %}
                          {% endwith %}
                        {% endif %}
                      {% endwith %}
                    {% endwith %}
                  {% endif %}
                {% endwith %}
              </h3>
                            {% comment %}Media display for item{% endcomment %}
              {% with item=qi.item %}
                {% if item.media %}
                  {% with media_url=item.media.url media_name=item.media.name media_type=item.get_media_type %}
                    <div class="mb-4">
                      {% if media_type == 'audio' %}
                        <audio controls class="w-full max-w-md">
                          <source src="{{ media_url }}" type="audio/mpeg">
                          Your browser does not support the audio element.
                        </audio>
                      {% elif media_type == 'video' %}
                        <video controls class="w-full max-w-md h-auto rounded">
                          <source src="{{ media_url }}" type="video/mp4">
                          Your browser does not support the video element.
                        </video>
                      {% elif media_type == 'image' %}
                        <img src="{{ media_url }}" alt="{{ qi.item.name|default:qi.item.translations.all.0.name }}" class="max-w-full h-auto rounded">
                      {% else %}
                        <div class="p-4 border border-gray-300 rounded">
                          <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                            üìé {{ media_name|default:"Download media file" }}
                          </a>
                        </div>
                      {% endif %}
                    </div>
                  {% endwith %}
                {% else %}
                  {% with item_translation=item.translations.language %}
                    {% if item_translation and item_translation.media %}
                      {% with media_url=item_translation.media.url media_name=item_translation.media.name media_type=item.get_media_type|default:'other' %}
                        <div class="mb-4">
                          {% if media_type == 'audio' %}
                            <audio controls class="w-full max-w-md">
                              <source src="{{ media_url }}" type="audio/mpeg">
                              Your browser does not support the audio element.
                            </audio>
                          {% elif media_type == 'video' %}
                            <video controls class="w-full max-w-md h-auto rounded">
                              <source src="{{ media_url }}" type="video/mp4">
                              Your browser does not support the video element.
                            </video>
                          {% elif media_type == 'image' %}
                            <img src="{{ media_url }}" alt="{{ qi.item.name|default:qi.item.translations.all.0.name }}" class="max-w-full h-auto rounded">
                          {% else %}
                            <div class="p-4 border border-gray-300 rounded">
                              <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                üìé {{ media_name|default:"Download media file" }}
                              </a>
                            </div>
                          {% endif %}
                        </div>
                      {% endwith %}
                    {% else %}
                      {% with en_translation=item.translations.language %}
                        {% if en_translation and en_translation.media %}
                          {% with media_url=en_translation.media.url media_name=en_translation.media.name media_type=item.get_media_type|default:'other' %}
                            <div class="mb-4">
                              {% if media_type == 'audio' %}
                                <audio controls class="w-full max-w-md">
                                  <source src="{{ media_url }}" type="audio/mpeg">
                                  Your browser does not support the audio element.
                                </audio>
                              {% elif media_type == 'video' %}
                                <video controls class="w-full max-w-md h-auto rounded">
                                  <source src="{{ media_url }}" type="video/mp4">
                                  Your browser does not support the video element.
                                </video>
                              {% elif media_type == 'image' %}
                                <img src="{{ media_url }}" alt="{{ qi.item.name|default:qi.item.translations.all.0.name }}" class="max-w-full h-auto rounded">
                              {% else %}
                                <div class="p-4 border border-gray-300 rounded">
                                  <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                    üìé {{ media_name|default:"Download media file" }}
                                  </a>
                                </div>
                              {% endif %}
                            </div>
                          {% endwith %}
                        {% else %}
                          {% with first_translation=item.translations.all.0 %}
                            {% if first_translation and first_translation.media %}
                              {% with media_url=first_translation.media.url media_name=first_translation.media.name media_type=item.get_media_type|default:'other' %}
                                <div class="mb-4">
                                  {% if media_type == 'audio' %}
                                    <audio controls class="w-full max-w-md">
                                      <source src="{{ media_url }}" type="audio/mpeg">
                                      Your browser does not support the audio element.
                                    </audio>
                                  {% elif media_type == 'video' %}
                                    <video controls class="w-full max-w-md h-auto rounded">
                                      <source src="{{ media_url }}" type="video/mp4">
                                      Your browser does not support the video element.
                                    </video>
                                  {% elif media_type == 'image' %}
                                    <img src="{{ media_url }}" alt="{{ qi.item.name|default:qi.item.translations.all.0.name }}" class="max-w-full h-auto rounded">
                                  {% else %}
                                    <div class="p-4 border border-gray-300 rounded">
                                      <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                        üìé {{ media_name|default:"Download media file" }}
                                      </a>
                                    </div>
                                  {% endif %}
                                </div>
                              {% endwith %}
                            {% endif %}
                          {% endwith %}
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  {% endwith %}
                {% endif %}
              {% endwith %}
            </div>
          </div>

          <!-- Response Field -->
          <div class="response-field mb-6">
            {% if qi.item.response_type == 'Text' %}
              <div class="form-group">
                {{ form.response_qi.id }}
                <textarea name="response_{{ qi.id }}" 
                          class="w-full px-4 py-3 text-lg border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          rows="3"
                          placeholder="{% translate 'Enter your response here...' %}"></textarea>
              </div>

            {% elif qi.item.response_type == 'Number' %}
              <div class="form-group">
                {{ form.response_qi.id }}
                <input type="number" 
                       name="response_{{ qi.id }}"
                       class="w-full px-4 py-3 text-lg border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="{% translate 'Enter a number...' %}">
              </div>

            {% elif qi.item.response_type == 'Likert' %}
              <div class="form-group">
                {{ form.response_qi.id }}
                {% with option_count=item_data.translated_options|length %}
                  {% if option_count <= 6 %}
                    {% with col_count=option_count %}
                      <div class="likert-options grid 
                        grid-cols-1 
                        sm:grid-cols-2 
                        md:grid-cols-3 
                        lg:grid-cols-{{ col_count }}
                        gap-4 items-stretch">
                        {% for option in item_data.translated_options %}
                          <label class="likert-option relative">
                            <input type="radio" 
                                   name="response_{{ qi.id }}" 
                                   value="{{ option.option_value }}"
                                   class="peer sr-only">
                            <div class="option-content p-2 min-w-[120px] h-full flex flex-col items-center justify-center text-center border-2 rounded-md cursor-pointer bg-blue-50 border-blue-200 text-blue-700 peer-checked:bg-green-600 peer-checked:border-green-600 peer-checked:text-white hover:bg-blue-100 peer-checked:hover:bg-green-700 transition-colors duration-200">
                              {% comment %}Option media display with translation fallback{% endcomment %}
                              {% if option.option_media %}
                                {% with media_url=option.option_media.url media_name=option.option_media.name media_type=option.get_media_type %}
                                  <div class="mb-2">
                                    {% if media_type == 'image' %}
                                      <img src="{{ media_url }}" alt="{{ option.option_text }}" class="w-12 h-12 object-cover rounded">
                                    {% elif media_type == 'audio' %}
                                      <audio controls class="w-full max-w-[100px]">
                                        <source src="{{ media_url }}" type="audio/mpeg">
                                        Your browser does not support the audio element.
                                      </audio>
                                    {% elif media_type == 'video' %}
                                      <video controls class="w-full max-w-[100px] h-auto rounded">
                                        <source src="{{ media_url }}" type="video/mp4">
                                        Your browser does not support the video element.
                                      </video>
                                    {% else %}
                                      <div class="p-1 border border-gray-300 rounded text-xs">
                                        <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                          üìé {{ media_name|default:"Media"|truncatechars:10 }}
                                        </a>
                                      </div>
                                    {% endif %}
                                  </div>
                                {% endwith %}
                              {% else %}
                                {% comment %}Fallback to current language translation{% endcomment %}
                                {% with option_translation=option.translations.language %}
                                  {% if option_translation and option_translation.option_media %}
                                    {% with media_url=option_translation.option_media.url media_name=option_translation.option_media.name media_type=option.get_media_type|default:'other' %}
                                      <div class="mb-2">
                                        {% if media_type == 'image' %}
                                          <img src="{{ media_url }}" alt="{{ option.option_text }}" class="w-12 h-12 object-cover rounded">
                                        {% elif media_type == 'audio' %}
                                          <audio controls class="w-full max-w-[100px]">
                                            <source src="{{ media_url }}" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                          </audio>
                                        {% elif media_type == 'video' %}
                                          <video controls class="w-full max-w-[100px] h-auto rounded">
                                            <source src="{{ media_url }}" type="video/mp4">
                                            Your browser does not support the video element.
                                          </video>
                                        {% else %}
                                          <div class="p-1 border border-gray-300 rounded text-xs">
                                            <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                              üìé {{ media_name|default:"Media"|truncatechars:10 }}
                                            </a>
                                          </div>
                                        {% endif %}
                                      </div>
                                    {% endwith %}
                                  {% else %}
                                    {% comment %}Fallback to English translation{% endcomment %}
                                    {% with en_translation=option.translations.language %}
                                      {% if en_translation and en_translation.option_media %}
                                        {% with media_url=en_translation.option_media.url media_name=en_translation.option_media.name media_type=option.get_media_type|default:'other' %}
                                          <div class="mb-2">
                                            {% if media_type == 'image' %}
                                              <img src="{{ media_url }}" alt="{{ option.option_text }}" class="w-12 h-12 object-cover rounded">
                                            {% elif media_type == 'audio' %}
                                              <audio controls class="w-full max-w-[100px]">
                                                <source src="{{ media_url }}" type="audio/mpeg">
                                                Your browser does not support the audio element.
                                              </audio>
                                            {% elif media_type == 'video' %}
                                              <video controls class="w-full max-w-[100px] h-auto rounded">
                                                <source src="{{ media_url }}" type="video/mp4">
                                                Your browser does not support the video element.
                                              </video>
                                            {% else %}
                                              <div class="p-1 border border-gray-300 rounded text-xs">
                                                <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                                  üìé {{ media_name|default:"Media"|truncatechars:10 }}
                                                </a>
                                              </div>
                                            {% endif %}
                                          </div>
                                        {% endwith %}
                                      {% else %}
                                        {% comment %}Fallback to first available translation{% endcomment %}
                                        {% with first_translation=option.translations.all.0 %}
                                          {% if first_translation and first_translation.option_media %}
                                            {% with media_url=first_translation.option_media.url media_name=first_translation.option_media.name media_type=option.get_media_type|default:'other' %}
                                              <div class="mb-2">
                                                {% if media_type == 'image' %}
                                                  <img src="{{ media_url }}" alt="{{ option.option_text }}" class="w-12 h-12 object-cover rounded">
                                                {% elif media_type == 'audio' %}
                                                  <audio controls class="w-full max-w-[100px]">
                                                    <source src="{{ media_url }}" type="audio/mpeg">
                                                    Your browser does not support the audio element.
                                                  </audio>
                                                {% elif media_type == 'video' %}
                                                  <video controls class="w-full max-w-[100px] h-auto rounded">
                                                    <source src="{{ media_url }}" type="video/mp4">
                                                    Your browser does not support the video element.
                                                  </video>
                                                {% else %}
                                                  <div class="p-1 border border-gray-300 rounded text-xs">
                                                    <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                                      üìé {{ media_name|default:"Media"|truncatechars:10 }}
                                                    </a>
                                                  </div>
                                                {% endif %}
                                              </div>
                                            {% endwith %}
                                          {% endif %}
                                        {% endwith %}
                                      {% endif %}
                                    {% endwith %}
                                  {% endif %}
                                {% endwith %}
                              {% endif %}
                              <span class="text-2xl font-medium">
                                {% if option.option_emoji %}
                                  <span class="mr-2">{{ option.option_emoji }}</span>
                                {% endif %}
                                {{ option.option_text }}
                              </span>
                            </div>
                          </label>
                        {% endfor %}
                      </div>
                    {% endwith %}
                  {% else %}
                    {% with col_count=6 %}
                      <div class="likert-options grid 
                        grid-cols-1 
                        sm:grid-cols-2 
                        md:grid-cols-3 
                        lg:grid-cols-{{ col_count }}
                        gap-4 items-stretch">
                        {% for option in item_data.translated_options %}
                          <label class="likert-option relative">
                            <input type="radio" 
                                   name="response_{{ qi.id }}" 
                                   value="{{ option.option_value }}"
                                   class="peer sr-only">
                            <div class="option-content p-2 min-w-[120px] h-full flex flex-col items-center justify-center text-center border-2 rounded-md cursor-pointer bg-blue-50 border-blue-200 text-blue-700 peer-checked:bg-green-600 peer-checked:border-green-600 peer-checked:text-white hover:bg-blue-100 peer-checked:hover:bg-green-700 transition-colors duration-200">
                              {% comment %}Option media display with translation fallback{% endcomment %}
                              {% if option.option_media %}
                                {% with media_url=option.option_media.url media_name=option.option_media.name media_type=option.get_media_type %}
                                  <div class="mb-2">
                                    {% if media_type == 'image' %}
                                      <img src="{{ media_url }}" alt="{{ option.option_text }}" class="w-12 h-12 object-cover rounded">
                                    {% elif media_type == 'audio' %}
                                      <audio controls class="w-full max-w-[100px]">
                                        <source src="{{ media_url }}" type="audio/mpeg">
                                        Your browser does not support the audio element.
                                      </audio>
                                    {% elif media_type == 'video' %}
                                      <video controls class="w-full max-w-[100px] h-auto rounded">
                                        <source src="{{ media_url }}" type="video/mp4">
                                        Your browser does not support the video element.
                                      </video>
                                    {% else %}
                                      <div class="p-1 border border-gray-300 rounded text-xs">
                                        <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                          üìé {{ media_name|default:"Media"|truncatechars:10 }}
                                        </a>
                                      </div>
                                    {% endif %}
                                  </div>
                                {% endwith %}
                              {% else %}
                                {% comment %}Fallback to current language translation{% endcomment %}
                                {% with option_translation=option.translations.language %}
                                  {% if option_translation and option_translation.option_media %}
                                    {% with media_url=option_translation.option_media.url media_name=option_translation.option_media.name media_type=option.get_media_type|default:'other' %}
                                      <div class="mb-2">
                                        {% if media_type == 'image' %}
                                          <img src="{{ media_url }}" alt="{{ option.option_text }}" class="w-12 h-12 object-cover rounded">
                                        {% elif media_type == 'audio' %}
                                          <audio controls class="w-full max-w-[100px]">
                                            <source src="{{ media_url }}" type="audio/mpeg">
                                            Your browser does not support the audio element.
                                          </audio>
                                        {% elif media_type == 'video' %}
                                          <video controls class="w-full max-w-[100px] h-auto rounded">
                                            <source src="{{ media_url }}" type="video/mp4">
                                            Your browser does not support the video element.
                                          </video>
                                        {% else %}
                                          <div class="p-1 border border-gray-300 rounded text-xs">
                                            <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                              üìé {{ media_name|default:"Media"|truncatechars:10 }}
                                            </a>
                                          </div>
                                        {% endif %}
                                      </div>
                                    {% endwith %}
                                  {% else %}
                                    {% comment %}Fallback to English translation{% endcomment %}
                                    {% with en_translation=option.translations.language %}
                                      {% if en_translation and en_translation.option_media %}
                                        {% with media_url=en_translation.option_media.url media_name=en_translation.option_media.name media_type=option.get_media_type|default:'other' %}
                                          <div class="mb-2">
                                            {% if media_type == 'image' %}
                                              <img src="{{ media_url }}" alt="{{ option.option_text }}" class="w-12 h-12 object-cover rounded">
                                            {% elif media_type == 'audio' %}
                                              <audio controls class="w-full max-w-[100px]">
                                                <source src="{{ media_url }}" type="audio/mpeg">
                                                Your browser does not support the audio element.
                                              </audio>
                                            {% elif media_type == 'video' %}
                                              <video controls class="w-full max-w-[100px] h-auto rounded">
                                                <source src="{{ media_url }}" type="video/mp4">
                                                Your browser does not support the video element.
                                              </video>
                                            {% else %}
                                              <div class="p-1 border border-gray-300 rounded text-xs">
                                                <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                                  üìé {{ media_name|default:"Media"|truncatechars:10 }}
                                                </a>
                                              </div>
                                            {% endif %}
                                          </div>
                                        {% endwith %}
                                      {% else %}
                                        {% comment %}Fallback to first available translation{% endcomment %}
                                        {% with first_translation=option.translations.all.0 %}
                                          {% if first_translation and first_translation.option_media %}
                                            {% with media_url=first_translation.option_media.url media_name=first_translation.option_media.name media_type=option.get_media_type|default:'other' %}
                                              <div class="mb-2">
                                                {% if media_type == 'image' %}
                                                  <img src="{{ media_url }}" alt="{{ option.option_text }}" class="w-12 h-12 object-cover rounded">
                                                {% elif media_type == 'audio' %}
                                                  <audio controls class="w-full max-w-[100px]">
                                                    <source src="{{ media_url }}" type="audio/mpeg">
                                                    Your browser does not support the audio element.
                                                  </audio>
                                                {% elif media_type == 'video' %}
                                                  <video controls class="w-full max-w-[100px] h-auto rounded">
                                                    <source src="{{ media_url }}" type="video/mp4">
                                                    Your browser does not support the video element.
                                                  </video>
                                                {% else %}
                                                  <div class="p-1 border border-gray-300 rounded text-xs">
                                                    <a href="{{ media_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                                      üìé {{ media_name|default:"Media"|truncatechars:10 }}
                                                    </a>
                                                  </div>
                                                {% endif %}
                                              </div>
                                            {% endwith %}
                                          {% endif %}
                                        {% endwith %}
                                      {% endif %}
                                    {% endwith %}
                                  {% endif %}
                                {% endwith %}
                              {% endif %}
                              <span class="text-2xl font-medium">
                                {% if option.option_emoji %}
                                  <span class="mr-2">{{ option.option_emoji }}</span>
                                {% endif %}
                                {{ option.option_text }}
                              </span>
                            </div>
                          </label>
                        {% endfor %}
                      </div>
                    {% endwith %}
                  {% endif %}
                {% endwith %}
              </div>

            {% elif qi.item.response_type == 'Range' %}
              <div class="form-group">
                {{ form.response_qi.id }}
                <div class="range-slider-container">
                  <input type="range"
                         name="response_{{ qi.id }}"
                         min="{{ qi.item.range_response.min_value }}"
                         max="{{ qi.item.range_response.max_value }}"
                         step="{{ qi.item.range_response.increment }}"
                         class="w-full h-4 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                         oninput="this.nextElementSibling.value = this.value">
                  <output class="text-center block mt-4 text-2xl font-medium text-gray-700"></output>
                </div>
                <div class="flex justify-between text-lg font-medium text-gray-600 mt-2">
                  <span>
                    {% if item_data.translated_range_scale.min_value_text %}
                      {{ item_data.translated_range_scale.min_value_text }}
                    {% else %}
                      {{ qi.item.range_response.min_value }}
                    {% endif %}
                  </span>
                  <span>
                    {% if item_data.translated_range_scale.max_value_text %}
                      {{ item_data.translated_range_scale.max_value_text }}
                    {% else %}
                      {{ qi.item.range_response.max_value }}
                    {% endif %}
                  </span>
                </div>
              </div>
            {% endif %}
          </div>

          <!-- Navigation Buttons -->
          <div class="flex justify-between mt-6 pt-4 border-t border-gray-200">
            <button type="button" class="prev-btn px-4 py-2 text-base font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              {% translate "Previous Question" %}
            </button>
            <div class="flex space-x-3">
              <button type="button" class="next-btn px-4 py-2 text-base font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center">
                {% translate "Next Question" %}
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
              <button type="button" class="skip-to-submit-btn px-4 py-2 text-base font-medium text-white bg-orange-600 rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 flex items-center" style="display: none;">
                {% translate "Skip to Submit" %}
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5-5 5M6 12h12"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
        {% endwith %}
      {% endfor %}

      <!-- Thank You Section -->
      <div id="thank-you-section" class="bg-gradient-to-r from-green-50 to-blue-50 p-8 rounded-lg text-center transition-opacity duration-300 ease-in-out" style="display: none;">
        <div class="flex flex-col items-center space-y-6">
          <!-- Namaste Image Placeholder -->
          <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center">
            <!-- Placeholder for namaste image -->
            <span class="text-4xl">üôè</span>
            <!-- Replace above with: <img src="{% static 'path/to/namaste-image.png' %}" alt="Namaste" class="w-24 h-24 rounded-full"> -->
          </div>
          
          <!-- Thank You Message -->
          <div class="space-y-4">
            <h2 class="text-2xl font-bold text-gray-900">
              {% blocktrans with questionnaire_name=patient_questionnaire.questionnaire.name %}
                Thank you for answering this {{ questionnaire_name }}.
              {% endblocktrans %}
            </h2>
            <p class="text-lg text-gray-700 max-w-2xl mx-auto">
              {% translate "You may now submit your answers by clicking on the red submit button. If you wish to review your answers please click on the back to questionnaire button which will allow you to review all your responses." %}
            </p>
          </div>
          
          <!-- Submission Controls -->
          <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
            <button type="submit" id="submit-btn" class="bg-red-600 text-white px-8 py-3 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 text-lg font-medium">
              {% translate "Submit Responses" %}
            </button>
            <button type="button" id="back-to-questionnaire-btn" class="bg-gray-300 text-gray-800 px-8 py-3 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 text-lg font-medium">
              {% translate "Back to Questionnaire" %}
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

{% block extra_js %}
<script>
  // Get the rule evaluation URL template with a dummy UUID
  const ruleEvalBase = "{% url 'evaluate_question_rules' '00000000-0000-0000-0000-000000000000' %}";
  function getRuleEvalUrl(questionId) {
    return ruleEvalBase.replace('00000000-0000-0000-0000-000000000000', questionId);
  }

  document.addEventListener('DOMContentLoaded', function() {
    const questions = document.querySelectorAll('.question-item');
    const thankYouSection = document.getElementById('thank-you-section');
    const backToQuestionnaireBtn = document.getElementById('back-to-questionnaire-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('current-question-number');
    let currentQuestionIndex = 0;
    const responses = {};

    // Function to show a specific question with fade effect
    async function showQuestion(index) {
      // Hide thank you section if visible
      thankYouSection.style.display = 'none';
      
      // Fade out current question
      const currentQuestion = questions[currentQuestionIndex];
      if (currentQuestion) {
        currentQuestion.style.opacity = '0';
        await new Promise(resolve => setTimeout(resolve, 300)); // Wait for fade out
        currentQuestion.style.display = 'none';
      }
      
      // Show and fade in new question
      const newQuestion = questions[index];
      newQuestion.style.display = 'block';
      // Force a reflow
      newQuestion.offsetHeight;
      newQuestion.style.opacity = '1';
      
      // Update current index
      currentQuestionIndex = index;
      
      // Update progress bar
      const progress = ((index + 1) / questions.length) * 100;
      progressBar.style.width = progress + '%';
      progressText.textContent = `${index + 1}`;
      
      // Update button visibility for current question
      const prevBtn = newQuestion.querySelector('.prev-btn');
      const nextBtn = newQuestion.querySelector('.next-btn');
      const skipBtn = newQuestion.querySelector('.skip-to-submit-btn');
      
      // Enable/disable Previous button based on index
      prevBtn.disabled = index === 0;
      prevBtn.style.display = 'flex';  // Always show Previous button
      
      // Show/hide Next button and Skip to Submit button based on index
      if (index === questions.length - 1) {
        nextBtn.style.display = 'none';
        skipBtn.style.display = 'flex';  // Show Skip to Submit button on last question
      } else {
        nextBtn.style.display = 'flex';
        skipBtn.style.display = 'none';  // Hide Skip to Submit button on other questions
      }
    }

    // Function to show thank you section
    async function showThankYouSection() {
      // Hide current question
      const currentQuestion = questions[currentQuestionIndex];
      if (currentQuestion) {
        currentQuestion.style.opacity = '0';
        await new Promise(resolve => setTimeout(resolve, 300)); // Wait for fade out
        currentQuestion.style.display = 'none';
      }
      
      // Show thank you section
      thankYouSection.style.display = 'block';
      // Force a reflow
      thankYouSection.offsetHeight;
      thankYouSection.style.opacity = '1';
      
      // Update progress bar to 100%
      progressBar.style.width = '100%';
      progressText.textContent = questions.length;
    }

    // Function to return to questionnaire (first question)
    function backToQuestionnaire() {
      thankYouSection.style.display = 'none';
      showQuestion(0);
    }

    // Function to evaluate rules for a question
    async function evaluateRules(questionId) {
      try {
        const response = await fetch(getRuleEvalUrl(questionId), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify(responses)
        });
        const data = await response.json();
        return data.should_show;
      } catch (error) {
        console.error('Error evaluating rules:', error);
        return true; // Show question by default if there's an error
      }
    }

    // Function to check if we should advance to next question or show thank you
    async function handleQuestionAnswer() {
      // If this is the last question, show thank you section
      if (currentQuestionIndex === questions.length - 1) {
        showThankYouSection();
        return;
      }

      // Otherwise, find the next visible question
      for (let i = currentQuestionIndex + 1; i < questions.length; i++) {
        const nextQuestion = questions[i];
        const shouldShow = await evaluateRules(nextQuestion.dataset.questionId);
        if (shouldShow) {
          // Show the next visible question
          showQuestion(i);
          return;
        }
      }
      
      // If no more visible questions, show thank you section
      showThankYouSection();
    }

    // Handle input changes
    questions.forEach(question => {
      const inputs = question.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        input.addEventListener('change', async function() {
          const questionId = question.dataset.questionId;
          responses[questionId] = this.value;
          
          // Auto-advance if this is the current question
          if (questions[currentQuestionIndex] === question) {
            await handleQuestionAnswer();
          }
        });
      });
    });

    // Add click handlers for navigation buttons
    questions.forEach((question, index) => {
      const prevBtn = question.querySelector('.prev-btn');
      const nextBtn = question.querySelector('.next-btn');
      const skipBtn = question.querySelector('.skip-to-submit-btn');

      prevBtn.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
          showQuestion(currentQuestionIndex - 1);
        }
      });

      nextBtn.addEventListener('click', async () => {
        if (currentQuestionIndex < questions.length - 1) {
          showQuestion(currentQuestionIndex + 1);
        }
      });

      skipBtn.addEventListener('click', () => {
        showThankYouSection();
      });
    });

    // Handle Back to Questionnaire button
    backToQuestionnaireBtn.addEventListener('click', backToQuestionnaire);

    // Handle form submission
    document.getElementById('questionnaire-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Submit the form without validation
      this.submit();
    });

    // Show the first question
    showQuestion(0);
  });
</script>
{% endblock %}
{% endblock %} 