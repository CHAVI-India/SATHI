{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load cotton %}

{% block title %}{% translate "PRO Review" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/prom_review.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{{ bokeh_css|safe }}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{% translate "PRO Review" %}</h1>
                </div>
            </div>

            <!-- Main Content -->
            <div id="main-content" class="space-y-6">
                {% include "promapp/components/main_content.html" %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ bokeh_js|safe }}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        flatpickr("#submission-date", {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "d M Y",
            onChange: function(selectedDates, dateStr, instance) {
                // HTMX should pick up the change event automatically from the input field
                // If not, uncomment the line below to trigger it manually
                // htmx.trigger(instance.element, 'change');
            }
        });

        // Item filter functionality
        const itemSearchInput = document.getElementById('item-filter-search');
        const itemDropdown = document.getElementById('item-filter-dropdown');
        const selectedItemsSummary = document.getElementById('selected-items-summary');

        // Initialize selected items summary
        updateSelectedItemsSummary();

        // Function to update the selected items summary
        function updateSelectedItemsSummary() {
            const selectedInputs = document.querySelectorAll('#item-filter-inputs input[type="hidden"]');
            const count = selectedInputs.length;
            
            if (count === 0) {
                selectedItemsSummary.innerHTML = '<span class="text-gray-500">{% translate "All items shown" %}</span>';
            } else {
                const itemNames = Array.from(selectedInputs).map(input => input.getAttribute('data-item-name')).slice(0, 3);
                let summaryText = `${count} {% translate "item" %}${count !== 1 ? 's' : ''} {% translate "selected" %}`;
                if (count <= 3) {
                    summaryText += `: ${itemNames.join(', ')}`;
                } else {
                    summaryText += `: ${itemNames.join(', ')} + ${count - 3} {% translate "more" %}`;
                }
                selectedItemsSummary.innerHTML = `<span class="text-blue-600">${summaryText}</span>`;
            }
        }

        // Handle item selection from dropdown
        document.addEventListener('click', function(event) {
            if (event.target.matches('.item-option')) {
                const itemId = event.target.getAttribute('data-item-id');
                const itemName = event.target.getAttribute('data-item-name');
                
                // Check if item is already selected
                const existingInput = document.querySelector(`#item-filter-inputs input[value="${itemId}"]`);
                if (existingInput) {
                    // Remove if already selected
                    existingInput.remove();
                    event.target.classList.remove('bg-blue-50', 'text-blue-600');
                    event.target.classList.add('hover:bg-gray-50');
                } else {
                    // Add new selection
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'item_filter';
                    hiddenInput.value = itemId;
                    hiddenInput.setAttribute('data-item-name', itemName);
                    document.getElementById('item-filter-inputs').appendChild(hiddenInput);
                    
                    event.target.classList.add('bg-blue-50', 'text-blue-600');
                    event.target.classList.remove('hover:bg-gray-50');
                }
                
                updateSelectedItemsSummary();
                
                // Trigger HTMX update
                const form = document.createElement('form');
                const inputs = document.querySelectorAll('#item-filter-inputs input, [name="questionnaire_filter"], [name="time_range"], [name="submission_date"], [name="start_date_reference"], [name="time_interval"], [name="aggregation_type"], [name="patient_filter_gender"], [name="patient_filter_diagnosis"], [name="patient_filter_treatment"], [name="patient_filter_min_age"], [name="patient_filter_max_age"]');
                inputs.forEach(input => {
                    const clone = input.cloneNode(true);
                    form.appendChild(clone);
                });
                
                htmx.ajax('GET', "{% url 'prom_review' patient.id %}", {
                    source: form,
                    target: '#main-content'
                });
            }
        });

        // Show/hide dropdown on focus/blur
        if (itemSearchInput) {
            itemSearchInput.addEventListener('focus', function() {
                itemDropdown.classList.remove('hidden');
            });
        }

        document.addEventListener('click', function(event) {
            if (itemSearchInput && !itemSearchInput.contains(event.target) && !itemDropdown.contains(event.target)) {
                itemDropdown.classList.add('hidden');
            }
        });

        // Clear search when dropdown is hidden
        if (itemSearchInput) {
            itemSearchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    if (!itemDropdown.matches(':hover')) {
                        itemSearchInput.value = '';
                    }
                }, 200);
            });
        }
    });

    // Function to toggle full text display for text responses
    function toggleFullText(elementId) {
        const element = document.getElementById(elementId);
        const toggleButton = element.previousElementSibling;
        
        if (element.classList.contains('hidden')) {
            element.classList.remove('hidden');
            toggleButton.textContent = '{% translate "Show less" %}';
        } else {
            element.classList.add('hidden');
            toggleButton.textContent = '{% translate "Show more" %}';
        }
    }

    // Function to toggle filters section
    function toggleFilters() {
        const content = document.getElementById('filters-content');
        const chevron = document.getElementById('filters-chevron');
        
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.classList.add('rotate-180');
        } else {
            content.classList.add('hidden');
            chevron.classList.remove('rotate-180');
        }
    }

    // Function to toggle population comparison section
    function togglePopulationComparison() {
        const content = document.getElementById('population-content');
        const chevron = document.getElementById('population-chevron');
        
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.classList.add('rotate-180');
        } else {
            content.classList.add('hidden');
            chevron.classList.remove('rotate-180');
        }
    }

    // Function to toggle patient details within population comparison
    function togglePatientDetails() {
        const details = document.getElementById('patient-details');
        const chevron = document.getElementById('chevron-icon');
        
        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            chevron.classList.add('rotate-90');
        } else {
            details.classList.add('hidden');
            chevron.classList.remove('rotate-90');
        }
    }

    // Function to open image in modal (optional enhancement)
    function openImageModal(imageSrc, imageAlt) {
        // Create modal overlay
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        modal.onclick = function() { document.body.removeChild(modal); };
        
        // Create image container
        const imageContainer = document.createElement('div');
        imageContainer.className = 'max-w-4xl max-h-4xl p-4';
        imageContainer.onclick = function(e) { e.stopPropagation(); };
        
        // Create image
        const image = document.createElement('img');
        image.src = imageSrc;
        image.alt = imageAlt;
        image.className = 'max-w-full max-h-full rounded';
        
        imageContainer.appendChild(image);
        modal.appendChild(imageContainer);
        document.body.appendChild(modal);
    }
</script>
{% endblock %}
