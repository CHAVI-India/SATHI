{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load cotton %}

{% block title %}{% translate "PRO Review" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/prom_review.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{{ bokeh_css|safe }}
{% endblock %}

{% block content %}
<!-- Full-page loading overlay -->
<div id="page-loader" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm mx-4">
        <div class="flex flex-col items-center">
            <!-- Spinner -->
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-4"></div>
            <!-- Loading text -->
            <h3 class="text-lg font-semibold text-gray-900 mb-2">{% translate "Loading PRO Review" %}</h3>
            <p class="text-sm text-gray-600 text-center">{% translate "Calculating patient responses and aggregated data..." %}</p>
        </div>
    </div>
</div>

<div class="max-w-7xl mx-auto">
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{% translate "PRO Review" %}</h1>
                </div>
                <a href="{% url 'patient_list' %}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    {% translate "Back to Patient List" %}
                </a>
            </div>

            <!-- Help Card -->
            {% include 'promapp/components/help_card.html' %}

            <!-- Filters Section (outside of main-content to prevent replacement) -->
            {% include "promapp/components/filters_section.html" %}
            
            <!-- Main Content -->
            <div id="main-content" class="space-y-6">
                <!-- Content that gets updated by filters -->
                <div id="filterable-content">
                    {% include "promapp/components/main_content.html" %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ bokeh_js|safe }}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Hide the page loader once the page is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Hide loader after a short delay to ensure all content is rendered
        setTimeout(function() {
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.style.opacity = '0';
                loader.style.transition = 'opacity 0.3s ease-out';
                setTimeout(function() {
                    loader.style.display = 'none';
                }, 300);
            }
        }, 100);
        
        flatpickr("#submission-date", {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "d M Y",
            onChange: function(selectedDates, dateStr, instance) {
                // HTMX should pick up the change event automatically from the input field
                // If not, uncomment the line below to trigger it manually
                // htmx.trigger(instance.element, 'change');
            }
        });

        // Initialize item filter functionality
        initializeItemFilter();
        
        // Initialize plot indicator functionality
        initializePlotIndicators();
        
        // Restore filter state on page load
        restoreFilterState();
        
        // Restore population comparison state on page load
        restorePopulationState();
    });
    
    // Add HTMX event listener to reinitialize after content updates
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'filterable-content') {
            // Reinitialize item filter functionality after HTMX content swap
            initializeItemFilter();
            // Reinitialize plot indicator functionality after HTMX content swap
            initializePlotIndicators();
        }
    });
    
    function initializeItemFilter() {
        // Item filter functionality
        const itemSearchInput = document.getElementById('item-filter-search');
        const itemDropdown = document.getElementById('item-filter-dropdown');
        const selectedItemsSummary = document.getElementById('selected-items-summary');



        // Handle item selection from dropdown
        document.addEventListener('click', function(event) {
            if (event.target.matches('.item-option') || event.target.closest('.item-option')) {
                const itemOption = event.target.matches('.item-option') ? event.target : event.target.closest('.item-option');
                const itemId = itemOption.getAttribute('data-item-id');
                const itemName = itemOption.getAttribute('data-item-name');
                
                // Check if item is already selected
                const existingInput = document.querySelector(`#item-filter-inputs input[value="${itemId}"]`);
                if (existingInput) {
                    // Remove if already selected
                    existingInput.remove();
                    itemOption.classList.remove('bg-blue-50', 'text-blue-600');
                    itemOption.classList.add('hover:bg-gray-50');
                } else {
                    // Add new selection
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'item_filter';
                    hiddenInput.value = itemId;
                    hiddenInput.setAttribute('data-item-name', itemName);
                    document.getElementById('item-filter-inputs').appendChild(hiddenInput);
                    
                    itemOption.classList.add('bg-blue-50', 'text-blue-600');
                    itemOption.classList.remove('hover:bg-gray-50');
                }
                
                updateSelectedItemsSummary();
                
                // Note: No longer auto-submitting - user must click "Apply Filters" button
            }
        });

        // Show/hide dropdown on focus/blur and add search functionality
        if (itemSearchInput && itemDropdown) {
            // Show dropdown on focus
            itemSearchInput.addEventListener('focus', function() {
                // If dropdown is empty, trigger HTMX to load items
                const existingItems = itemDropdown.querySelectorAll('.item-option');
                if (existingItems.length === 0) {
                    // Trigger the HTMX search to populate dropdown
                    const questionnaireFilter = document.querySelector('[name="questionnaire_filter"]');
                    const params = new URLSearchParams();
                    if (questionnaireFilter && questionnaireFilter.value) {
                        params.append('questionnaire_filter', questionnaireFilter.value);
                    }
                    params.append('item-filter-search', ''); // Empty search to get all items
                    
                    const url = itemSearchInput.getAttribute('hx-get') + '?' + params.toString();
                    htmx.ajax('GET', url, {
                        target: itemDropdown
                    });
                }
                itemDropdown.classList.remove('hidden');
            });
            
            // Add search functionality to filter the dropdown items
            itemSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const items = itemDropdown.querySelectorAll('.item-option');
                
                items.forEach(item => {
                    const itemName = item.getAttribute('data-item-name').toLowerCase();
                    const constructName = item.querySelector('.text-xs') ? item.querySelector('.text-xs').textContent.toLowerCase() : '';
                    
                    if (itemName.includes(searchTerm) || constructName.includes(searchTerm)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Show dropdown when typing
                itemDropdown.classList.remove('hidden');
            });
        }

        document.addEventListener('click', function(event) {
            if (itemSearchInput && !itemSearchInput.contains(event.target) && !itemDropdown.contains(event.target)) {
                itemDropdown.classList.add('hidden');
            }
        });

        // Clear search when dropdown is hidden
        if (itemSearchInput) {
            itemSearchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    if (!itemDropdown.matches(':hover')) {
                        itemSearchInput.value = '';
                    }
                }, 200);
            });
        }
        
        // Update selected items summary on initialization
        if (selectedItemsSummary) {
            updateSelectedItemsSummary();
        }
        
        // Debug: Check if dropdown has items after initialization
        if (itemDropdown) {
            const existingItems = itemDropdown.querySelectorAll('.item-option');
            console.log('Item filter initialized. Available items:', existingItems.length);
            
            // If dropdown has items but is hidden, this is expected behavior
            // Items will show when user clicks on search input
        }
        
        // Function to update the selected items summary (moved inside initializeItemFilter)
        function updateSelectedItemsSummary() {
            const selectedInputs = document.querySelectorAll('#item-filter-inputs input[type="hidden"]');
            const count = selectedInputs.length;
            
            // Clear existing content
            selectedItemsSummary.innerHTML = '';
            
            if (count === 0) {
                const span = document.createElement('span');
                span.className = 'text-gray-500';
                span.textContent = '{% translate "All items shown" %}';
                selectedItemsSummary.appendChild(span);
            } else {
                const itemNames = Array.from(selectedInputs).map(input => input.getAttribute('data-item-name')).slice(0, 3);
                let summaryText = `${count} {% translate "item" %}${count !== 1 ? 's' : ''} {% translate "selected" %}`;
                if (count <= 3) {
                    summaryText += `: ${itemNames.join(', ')}`;
                } else {
                    summaryText += `: ${itemNames.join(', ')} + ${count - 3} {% translate "more" %}`;
                }
                
                // Safely create and append the span element
                const span = document.createElement('span');
                span.className = 'text-blue-600';
                span.textContent = summaryText; // textContent automatically escapes HTML
                selectedItemsSummary.appendChild(span);
            }
        }
    }

    // Function to toggle full text display for text responses
    function toggleFullText(elementId) {
        const element = document.getElementById(elementId);
        const toggleButton = element.previousElementSibling;
        
        if (element.classList.contains('hidden')) {
            element.classList.remove('hidden');
            toggleButton.textContent = '{% translate "Show less" %}';
        } else {
            element.classList.add('hidden');
            toggleButton.textContent = '{% translate "Show more" %}';
        }
    }

    // Function to toggle filters section
    function toggleFilters() {
        const content = document.getElementById('filters-content');
        const chevron = document.getElementById('filters-chevron');
        
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.classList.add('rotate-180');
            localStorage.setItem('filters-expanded', 'true');
        } else {
            content.classList.add('hidden');
            chevron.classList.remove('rotate-180');
            localStorage.setItem('filters-expanded', 'false');
        }
    }

    // Function to restore filter state
    function restoreFilterState() {
        const isExpanded = localStorage.getItem('filters-expanded') === 'true';
        const content = document.getElementById('filters-content');
        const chevron = document.getElementById('filters-chevron');
        
        if (isExpanded && content && chevron) {
            content.classList.remove('hidden');
            chevron.classList.add('rotate-180');
        }
    }

    // Function to toggle population comparison section
    function togglePopulationComparison() {
        const content = document.getElementById('population-content');
        const chevron = document.getElementById('population-chevron');
        
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.classList.add('rotate-180');
            localStorage.setItem('population-expanded', 'true');
        } else {
            content.classList.add('hidden');
            chevron.classList.remove('rotate-180');
            localStorage.setItem('population-expanded', 'false');
        }
    }

    // Function to restore population comparison state
    function restorePopulationState() {
        const isExpanded = localStorage.getItem('population-expanded') === 'true';
        const content = document.getElementById('population-content');
        const chevron = document.getElementById('population-chevron');
        
        if (isExpanded && content && chevron) {
            content.classList.remove('hidden');
            chevron.classList.add('rotate-180');
        }
    }

    // Function to toggle patient details within population comparison
    function togglePatientDetails() {
        const details = document.getElementById('patient-details');
        const chevron = document.getElementById('chevron-icon');
        
        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            chevron.classList.add('rotate-90');
        } else {
            details.classList.add('hidden');
            chevron.classList.remove('rotate-90');
        }
    }

    // Function to initialize plot indicator functionality
    function initializePlotIndicators() {
        // Add event listeners to all plot indicator checkboxes
        const checkboxes = document.querySelectorAll('.plot-indicator-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handlePlotIndicatorChange);
        });
        
        // Restore previously selected indicators from URL parameters or localStorage
        restorePlotIndicatorState();
    }

    // Function to restore plot indicator state
    function restorePlotIndicatorState() {
        // First check if there are selected indicators in the URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const selectedIndicatorsParam = urlParams.get('selected_indicators');
        
        // Also check localStorage for persistent state
        const storedIndicators = localStorage.getItem('selected_plot_indicators');
        
        let indicatorsToRestore = [];
        
        if (selectedIndicatorsParam) {
            try {
                indicatorsToRestore = JSON.parse(selectedIndicatorsParam);
            } catch (e) {
                console.warn('Failed to parse selected indicators from URL:', e);
            }
        } else if (storedIndicators) {
            try {
                indicatorsToRestore = JSON.parse(storedIndicators);
            } catch (e) {
                console.warn('Failed to parse stored indicators:', e);
            }
        }
        
        // Restore checkbox states
        indicatorsToRestore.forEach(indicator => {
            const checkbox = document.querySelector(`[data-type="${indicator.type}"][data-id="${indicator.id}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }

    // Function to handle plot indicator checkbox changes
    function handlePlotIndicatorChange() {
        // Collect all selected indicators
        const selectedIndicators = [];
        const checkboxes = document.querySelectorAll('.plot-indicator-checkbox:checked');
        
        checkboxes.forEach(checkbox => {
            selectedIndicators.push({
                type: checkbox.dataset.type,
                id: checkbox.dataset.id,
                date: checkbox.dataset.date,
                label: checkbox.dataset.label
            });
        });
        
        // Store selected indicators in a hidden input for form submission
        let indicatorsInput = document.getElementById('selected-indicators-input');
        if (!indicatorsInput) {
            indicatorsInput = document.createElement('input');
            indicatorsInput.type = 'hidden';
            indicatorsInput.id = 'selected-indicators-input';
            indicatorsInput.name = 'selected_indicators';
            // Append to filters form instead of body
            const filtersForm = document.getElementById('filters-form');
            if (filtersForm) {
                filtersForm.appendChild(indicatorsInput);
            } else {
                document.body.appendChild(indicatorsInput);
            }
        }
        
        indicatorsInput.value = JSON.stringify(selectedIndicators);
        
        // Store selected indicators in localStorage for persistence
        localStorage.setItem('selected_plot_indicators', JSON.stringify(selectedIndicators));
        
        // Note: No longer auto-submitting - user must click "Apply Plot Indicators" button
    }

    // Function to filter by questionnaire from questionnaire overview
    function filterByQuestionnaire(questionnaireId) {
        const loader = document.getElementById('filter-loader');
        
        // Show loader
        if (loader) {
            loader.style.display = 'flex';
        }
        
        // Get current filter values from the form
        const form = document.getElementById('filters-form');
        const formData = form ? new FormData(form) : new FormData();
        const params = new URLSearchParams();
        
        // Add all form fields to params
        for (let [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        // Add or update questionnaire filter
        params.set('questionnaire_filter', questionnaireId);
        
        // Build URL with parameters
        const url = "{% url 'prom_review' patient.id %}" + '?' + params.toString();
        
        // Make HTMX request
        htmx.ajax('GET', url, {
            target: '#filterable-content',
            swap: 'innerHTML'
        }).then(function() {
            // Hide loader after content is loaded
            if (loader) {
                setTimeout(function() {
                    loader.style.opacity = '0';
                    loader.style.transition = 'opacity 0.3s ease-out';
                    setTimeout(function() {
                        loader.style.display = 'none';
                        loader.style.opacity = '1';
                    }, 300);
                }, 100);
            }
        }).catch(function() {
            // Hide loader on error
            if (loader) {
                loader.style.display = 'none';
            }
        });
    }

    // Function to clear questionnaire filter
    function clearQuestionnaireFilter() {
        const loader = document.getElementById('filter-loader');
        
        // Show loader
        if (loader) {
            loader.style.display = 'flex';
        }
        
        // Get current filter values from the form
        const form = document.getElementById('filters-form');
        const formData = form ? new FormData(form) : new FormData();
        const params = new URLSearchParams();
        
        // Add all form fields to params except questionnaire_filter
        for (let [key, value] of formData.entries()) {
            if (key !== 'questionnaire_filter' && value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        // Build URL with parameters
        const url = "{% url 'prom_review' patient.id %}" + '?' + params.toString();
        
        // Make HTMX request
        htmx.ajax('GET', url, {
            target: '#filterable-content',
            swap: 'innerHTML'
        }).then(function() {
            // Hide loader after content is loaded
            if (loader) {
                setTimeout(function() {
                    loader.style.opacity = '0';
                    loader.style.transition = 'opacity 0.3s ease-out';
                    setTimeout(function() {
                        loader.style.display = 'none';
                        loader.style.opacity = '1';
                    }, 300);
                }, 100);
            }
        }).catch(function() {
            // Hide loader on error
            if (loader) {
                loader.style.display = 'none';
            }
        });
    }

    // Function to apply plot indicators manually
    function applyPlotIndicators() {
        const loader = document.getElementById('filter-loader');
        
        // Show loader
        if (loader) {
            loader.style.display = 'flex';
        }
        
        // Collect all selected indicators
        const selectedIndicators = [];
        const checkboxes = document.querySelectorAll('.plot-indicator-checkbox:checked');
        
        checkboxes.forEach(checkbox => {
            selectedIndicators.push({
                type: checkbox.dataset.type,
                id: checkbox.dataset.id,
                date: checkbox.dataset.date,
                label: checkbox.dataset.label
            });
        });
        
        // Get current filter values from the form
        const form = document.getElementById('filters-form');
        const formData = form ? new FormData(form) : new FormData();
        const params = new URLSearchParams();
        
        // Add all form fields to params
        for (let [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        // Add selected indicators
        if (selectedIndicators.length > 0) {
            params.append('selected_indicators', JSON.stringify(selectedIndicators));
        }
        
        // Build URL with parameters
        const url = "{% url 'prom_review' patient.id %}" + '?' + params.toString();
        
        // Make HTMX request
        htmx.ajax('GET', url, {
            target: '#filterable-content',
            swap: 'innerHTML'
        }).then(function() {
            // Hide loader after content is loaded
            if (loader) {
                setTimeout(function() {
                    loader.style.opacity = '0';
                    loader.style.transition = 'opacity 0.3s ease-out';
                    setTimeout(function() {
                        loader.style.display = 'none';
                        loader.style.opacity = '1';
                    }, 300);
                }, 100);
            }
        }).catch(function() {
            // Hide loader on error
            if (loader) {
                loader.style.display = 'none';
            }
        });
    }

    // Function to open image in modal (optional enhancement)
    function openImageModal(imageSrc, imageAlt) {
        // Create modal overlay
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        modal.onclick = function() { document.body.removeChild(modal); };
        
        // Create image container
        const imageContainer = document.createElement('div');
        imageContainer.className = 'max-w-4xl max-h-4xl p-4';
        imageContainer.onclick = function(e) { e.stopPropagation(); };
        
        // Create image
        const image = document.createElement('img');
        image.src = imageSrc;
        image.alt = imageAlt;
        image.className = 'max-w-full max-h-full rounded';
        
        imageContainer.appendChild(image);
        modal.appendChild(imageContainer);
        document.body.appendChild(modal);
    }

    // Function to switch between vertical tabs
    function switchTab(section, constructId) {
        // Determine which section we're working with
        let tabBtnClass, tabContentClass, activeColor;
        
        if (section === 'topline') {
            tabBtnClass = 'topline-tab-btn';
            tabContentClass = 'topline-tab-content';
            activeColor = 'red';
        } else if (section === 'composite') {
            tabBtnClass = 'composite-tab-btn';
            tabContentClass = 'composite-tab-content';
            activeColor = 'blue';
        } else {
            tabBtnClass = 'other-tab-btn';
            tabContentClass = 'other-tab-content';
            activeColor = 'green';
        }
        
        // Hide all tab contents in this section
        const allContents = document.querySelectorAll('.' + tabContentClass);
        allContents.forEach(content => {
            content.classList.add('hidden');
        });
        
        // Remove active state from all tab buttons in this section
        const allButtons = document.querySelectorAll('.' + tabBtnClass);
        allButtons.forEach(btn => {
            btn.classList.remove('bg-' + activeColor + '-50', 'border-l-4', 'border-' + activeColor + '-500', 'text-' + activeColor + '-700');
            btn.classList.add('text-gray-700', 'hover:bg-gray-50');
            btn.setAttribute('aria-selected', 'false');
        });
        
        // Show the selected tab content
        const selectedContent = document.getElementById(section + '-tab-' + constructId);
        if (selectedContent) {
            selectedContent.classList.remove('hidden');
        }
        
        // Add active state to the clicked button
        const selectedButton = document.getElementById(section + '-tab-btn-' + constructId);
        if (selectedButton) {
            selectedButton.classList.remove('text-gray-700', 'hover:bg-gray-50');
            selectedButton.classList.add('bg-' + activeColor + '-50', 'border-l-4', 'border-' + activeColor + '-500', 'text-' + activeColor + '-700');
            selectedButton.setAttribute('aria-selected', 'true');
        }
    }
</script>
{% endblock %}
