<c-vars
    construct_score
    submission_count
    patient
/>

<div class="bg-white border border-orange-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
    <div class="flex items-start justify-between mb-4">
        <div class="flex-1">
            <h3 class="font-semibold text-gray-900 mb-1">{{ construct_score.construct.name }}</h3>
            {% if construct_score.importance_reason %}
                <p class="text-xs text-orange-600 bg-orange-100 px-2 py-1 rounded-full inline-block">
                    {{ construct_score.importance_reason }}
                </p>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-3 print-single-col gap-4">
        <!-- Score Display (1/3) -->
        <div class="col-span-1">
            <div class="text-center">
                <div class="text-3xl font-bold text-gray-900 mb-1">
                    {{ construct_score.score|floatformat:1 }}
                </div>
                <div class="text-xs text-gray-500 mb-2">
                    Current Score
                </div>
                
                <!-- Change Indicator -->
                <c-hcp_results.widgets.change_indicator 
                    :current_score="construct_score.score" 
                    :previous_score="construct_score.previous_score" 
                    :direction="construct_score.construct.scale_better_score_direction" 
                />
            </div>
            
            <!-- Reference Values -->
            <div class="mt-3 space-y-1 text-xs">
                {% if construct_score.construct.scale_threshold_score %}
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Threshold:</span>
                        <span class="font-medium text-orange-600">{{ construct_score.construct.scale_threshold_score|floatformat:1 }}</span>
                    </div>
                {% endif %}
                {% if construct_score.construct.scale_normative_score_mean %}
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Normative:</span>
                        <span class="font-medium text-blue-600">{{ construct_score.construct.scale_normative_score_mean|floatformat:1 }}</span>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Plot Display (2/3) -->
        <div class="col-span-2">
            <div id="important-construct-plot-{{ construct_score.construct.id }}" class="w-full h-48"></div>
        </div>
    </div>
</div>

<!-- Plot data for JavaScript initialization -->
<script type="application/json" id="plot-data-{{ construct_score.construct.id }}">
{
    "plotId": "important-construct-plot-{{ construct_score.construct.id }}",
    "constructName": "{{ construct_score.construct.name|escapejs }}",
    "historicalData": [
        {% for score in construct_score.historical_data %}
        {
            "date": "{{ score.questionnaire_submission.submission_date|date:'Y-m-d' }}",
            "score": {{ score.score|default:"null" }},
            "submissionDate": "{{ score.questionnaire_submission.submission_date|date:'M d, Y H:i'|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    "thresholdScore": {% if construct_score.construct.scale_threshold_score %}{{ construct_score.construct.scale_threshold_score }}{% else %}null{% endif %},
    "normativeMean": {% if construct_score.construct.scale_normative_score_mean %}{{ construct_score.construct.scale_normative_score_mean }}{% else %}null{% endif %},
    "normativeSD": {% if construct_score.construct.scale_normative_score_standard_deviation %}{{ construct_score.construct.scale_normative_score_standard_deviation }}{% else %}null{% endif %}
}
</script> 