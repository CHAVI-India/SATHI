<c-vars
    construct_group
    submission_count
    patient
/>

<div class="border border-gray-200 rounded-lg overflow-hidden">
    <!-- Fieldset Header -->
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <button 
                    type="button"
                    class="fieldset-toggle-icon transform transition-transform duration-200 no-print"
                    data-construct="{{ construct_group.construct.id }}"
                    onclick="toggleFieldset('{{ construct_group.construct.id }}')"
                >
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                
                <div>
                    <h3 class="text-lg font-medium text-gray-900">
                        {{ construct_group.construct.name }}
                    </h3>
                    {% if construct_group.construct.description %}
                        <p class="text-sm text-gray-600">{{ construct_group.construct.description|truncatewords:15 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Construct Score -->
                {% if construct_group.construct_score %}
                    <div class="text-right">
                        <div class="text-lg font-semibold text-gray-900">
                            {{ construct_group.construct_score.score|floatformat:1 }}
                        </div>
                        <div class="text-xs text-gray-500">Construct Score</div>
                    </div>
                {% endif %}
                
                <!-- Sparkline -->
                <div class="w-24 h-12">
                    <div id="sparkline-{{ construct_group.construct.id }}" class="w-full h-full"></div>
                </div>
                
                <!-- Item Count -->
                <div class="text-sm text-gray-500">
                    {{ construct_group.items|length }} item{{ construct_group.items|length|pluralize }}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fieldset Content -->
    <div id="fieldset-content-{{ construct_group.construct.id }}" class="fieldset-content">
        <div class="p-4">
            {% if construct_group.items %}
                <div class="space-y-4">
                    {% for item_data in construct_group.items %}
                        {% if item_data.item.response_type == "Text" %}
                            <c-hcp_results.text_item_card 
                                :item_data="item_data" 
                                :submission_count="submission_count" 
                                :patient="patient" 
                            />
                        {% elif item_data.item.response_type == "Number" %}
                            <c-hcp_results.numeric_item_card 
                                :item_data="item_data" 
                                :submission_count="submission_count" 
                                :patient="patient" 
                            />
                        {% elif item_data.item.response_type == "Range" %}
                            <c-hcp_results.range_item_card 
                                :item_data="item_data" 
                                :submission_count="submission_count" 
                                :patient="patient" 
                            />
                        {% elif item_data.item.response_type == "Likert" %}
                            <c-hcp_results.likert_item_card 
                                :item_data="item_data" 
                                :submission_count="submission_count" 
                                :patient="patient" 
                            />
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8 text-gray-500">
                    <p>No items found for this construct.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Sparkline data for JavaScript initialization -->
<script type="application/json" id="sparkline-data-{{ construct_group.construct.id }}">
{
    "plotId": "sparkline-{{ construct_group.construct.id }}",
    "constructName": "{{ construct_group.construct.name|escapejs }}",
    "historicalData": [
        {% for score in construct_group.construct_historical_data %}
        {
            "date": "{{ score.questionnaire_submission.submission_date|date:'Y-m-d' }}",
            "score": {{ score.score|default:"null" }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
}
</script> 