{% load i18n %}
{% load cotton %}



<!-- Check for empty state -->
<c-list_card :items="patients" empty_message="{% translate 'No patients found' %}" />

<!-- Manual iteration for each patient card -->
<div class="space-y-4">
    {% for patient in patients %}
    <c-card 
        shadow="sm" 
        border="light" 
        padding="md" 
        class="w-full hover:shadow-md transition-shadow duration-200">
        
        <!-- Patient card content -->
        <div class="space-y-4">
            <!-- Top row: Patient info and action buttons -->
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3">
                <!-- Left side: Patient info -->
                <div class="flex-1 min-w-0">
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-medium text-gray-900 truncate">{{ patient.name }}</h3>
                            <p class="text-sm text-gray-600">ID: {{ patient.patient_id }}</p>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6 text-sm text-gray-600">
                            <span>Age: {{ patient.age }}</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 w-fit">
                                {{ patient.gender }}
                            </span>
                            {% if patient.institution %}
                            <span class="truncate">{{ patient.institution.name }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Right side: Action buttons -->
                <div class="flex space-x-2 sm:flex-shrink-0">
                    {% if patient.id %}
                    <c-view_button href="{% url 'patient_detail' patient.id %}" size="sm">
                        {% translate "View" %}
                    </c-view_button>
                    <c-link_button href="{% url 'patient_questionnaire_management' patient.id %}" variant="success" size="sm">
                        {% translate "Manage Questionnaires" %}
                    </c-link_button>
                    {% else %}
                    <span class="text-sm text-gray-500">No ID available</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Bottom row: Diagnoses and Treatments -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-3 border-t border-gray-100">
                <!-- Diagnoses -->
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">{% translate "Diagnoses" %}</h4>
                    {% if patient.diagnosis_set.all %}
                        <div class="flex flex-wrap gap-1">
                            {% for diagnosis in patient.diagnosis_set.all %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ diagnosis.diagnosis|truncatechars:30 }}
                            </span>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-sm text-gray-500 italic">{% translate "No diagnoses recorded" %}</p>
                    {% endif %}
                </div>
                
                <!-- Treatments -->
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">{% translate "Treatments" %}</h4>
                    {% regroup patient.diagnosis_set.all by id as diagnosis_list %}
                    {% if diagnosis_list %}
                        <div class="flex flex-wrap gap-1">
                            {% for diagnosis in patient.diagnosis_set.all %}
                                {% for treatment in diagnosis.treatment_set.all %}
                                    {% for treatment_type in treatment.treatment_type.all %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        {{ treatment_type.treatment_type|truncatechars:25 }}
                                    </span>
                                    {% endfor %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-sm text-gray-500 italic">{% translate "No treatments recorded" %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </c-card>
    {% endfor %}
</div>



<!-- Pagination -->
<c-paginator 
    :page_obj="page_obj" 
    :is_paginated="is_paginated" 
    show_info="true"
    show_page_numbers="true" /> 