{% extends 'base.html' %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load cotton %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" integrity="sha256-zaSoHBhwFdle0scfGEFUCwggPN7F+ip9XRglo8IWb4w=" crossorigin="anonymous" />
<style>
    /* Custom Select2 styling to match Tailwind */
    .select2-container--default .select2-selection--multiple {
        min-height: 38px;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__rendered {
        padding: 2px 8px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #3b82f6;
        border: 1px solid #2563eb;
        color: white;
        padding: 2px 8px;
        border-radius: 0.25rem;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 5px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
        color: #dbeafe;
    }
    .select2-container--default.select2-container--focus .select2-selection--multiple {
        border-color: #3b82f6;
        outline: none;
        box-shadow: 0 0 0 1px #3b82f6;
    }
    .select2-dropdown {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
    }
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900">{{ title }}</h2>
        </div>
        
        <!-- Guidance Section -->
        <div class="px-6 py-4 bg-blue-50 border-b border-blue-200">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">{% translate "Treatment Entry Guidelines" %}</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Use this form to specify treatments delivered to the specific diagnosis.</li>
                            <li><strong>Synchronous treatments:</strong> Select multiple treatment types that are being delivered at the same time.</li>
                            <li><strong>Sequential treatments:</strong> Create separate treatment entries for each treatment phase delivered one after another.</li>
                            <li>This allows for longitudinal data updates as treatments progress or change over time.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="px-6 py-4">
            <form method="post">
                {% csrf_token %}
                {% for field in form %}
                    {% if field.name == 'treatment_type' %}
                    <!-- Wrapper for the treatment type field for HTMX refresh -->
                    <div id="treatment-type-select-wrapper" class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                {{ field.label }}
                            </label>
                            {% if perms.patientapp.add_treatmenttype %}
                                <c-button
                                    type="button"
                                    size="sm"
                                    variant="outline"
                                    hx-get="{% url 'treatment_type_create' %}"
                                    hx-target="#modal-content"
                                    hx-swap="innerHTML"
                                >
                                    {% translate "Add New Treatment Type" %}
                                </c-button>
                            {% endif %}
                        </div>
                        {{ field|as_crispy_field }}
                    </div>
                    {% elif field.name == 'currently_ongoing_treatment' %}
                    <!-- Special handling for the boolean field -->
                    <div class="mb-4">
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input type="checkbox" 
                                       id="{{ field.id_for_label }}" 
                                       name="{{ field.name }}" 
                                       {% if field.value %}checked{% endif %}
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                       onchange="toggleEndDateField(this)"
                                >
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="{{ field.id_for_label }}" class="font-medium text-gray-700">
                                    {{ field.label }}
                                </label>
                                {% if field.help_text %}
                                    <p class="text-gray-500">{{ field.help_text }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% elif field.name == 'date_of_end_of_treatment' %}
                    <!-- End date field with dynamic visibility -->
                    <div id="end-date-field-wrapper" class="mb-4" {% if form.currently_ongoing_treatment.value %}style="display: none;"{% endif %}>
                        {{ field|as_crispy_field }}
                    </div>
                    {% else %}
                    <!-- Other fields -->
                    <div class="mb-4">
                        {{ field|as_crispy_field }}
                    </div>
                    {% endif %}
                {% endfor %}
                <div class="mt-6 flex justify-end space-x-3">
                    <c-link_button href="{% url 'patient_detail' diagnosis.patient.id %}" variant="secondary">
                        {% translate "Cancel" %}
                    </c-link_button>
                    <c-save_button>
                        {% if object %}{% translate "Update" %}{% else %}{% translate "Add" %}{% endif %}
                    </c-save_button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" integrity="sha256-9yRP/2EFlblE92vzCA10469Ctd0jT48HnmmMw5rJZrA=" crossorigin="anonymous"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 for treatment_type field (multiple selection)
    $('#id_treatment_type').select2({
        placeholder: '{% translate "Select treatment type(s)..." %}',
        allowClear: true,
        width: '100%',
        closeOnSelect: false // Keep dropdown open for multiple selections
    });
});

function toggleEndDateField(checkbox) {
    const endDateWrapper = document.getElementById('end-date-field-wrapper');
    const endDateInput = endDateWrapper.querySelector('input[type="date"]');
    
    if (checkbox.checked) {
        endDateWrapper.style.display = 'none';
        // Clear the end date value when hiding the field
        if (endDateInput) {
            endDateInput.value = '';
        }
    } else {
        endDateWrapper.style.display = 'block';
    }
}

// Initialize the field visibility on page load
document.addEventListener('DOMContentLoaded', function() {
    const ongoingCheckbox = document.querySelector('input[name="currently_ongoing_treatment"]');
    if (ongoingCheckbox) {
        toggleEndDateField(ongoingCheckbox);
    }
});
</script>
{% endblock %} 