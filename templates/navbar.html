{% load i18n %}

<nav class="bg-blue-600">
  <div class="mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <a href="/" class="text-white font-bold text-xl">CHAVI PROM Application</a>
        </div>
        <div class="hidden md:block">
          <div class="ml-10 flex items-baseline space-x-4">
            <a href="/" class="text-white hover:bg-blue-700 px-3 py-2 rounded-md text-sm font-medium">{% translate "Home" %}</a>
            {% if user.is_authenticated and perms.patientapp.view_patient %}
            <a href="{% url 'patient_list' %}" class="text-white hover:bg-blue-700 px-3 py-2 rounded-md text-sm font-medium">{% translate "Patients" %}</a>
            {% endif %}
            {% if user.is_authenticated and perms.promapp.view_questionnaire %}
            <div class="relative group inline-block">
              <button class="text-white hover:bg-blue-700 px-3 py-2 rounded-md text-sm font-medium flex items-center" aria-haspopup="true">
                {% translate "Instruments" %}
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
              <div class="absolute left-0 hidden pt-2 group-hover:block z-10">
                <div class="bg-white rounded-md shadow-lg py-1 min-w-max">
                  <!-- Create Questionnaire Section -->
                  <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                    {% translate "Create Questionnaire" %}
                  </div>
                  {% if perms.promapp.view_constructscale %}
                  <a href="{% url 'construct_scale_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    {% translate "Construct Scales" %}
                  </a>
                  {% endif %}
                  {% if perms.promapp.view_compositeconstructscalescoring %}
                  <a href="{% url 'composite_construct_scale_scoring_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    {% translate "Composite Construct Scales" %}
                  </a>
                  {% endif %}
                  {% if perms.promapp.view_item %}
                  <a href="{% url 'item_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    {% translate "Items (Questions)" %}
                  </a>
                  {% endif %}
                  <a href="{% url 'questionnaire_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    {% translate "Questionnaires" %}
                  </a>
                  {% if perms.promapp.view_likertscale %}
                  <a href="{% url 'likert_scale_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    {% translate "Likert Scales" %}
                  </a>
                  {% endif %}
                  {% if perms.promapp.view_rangescale %}
                  <a href="{% url 'range_scale_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    {% translate "Range Scales" %}
                  </a>
                  {% endif %}
                  
                  <!-- Separator -->
                  <div class="border-t border-gray-200 my-1"></div>
                  
                  <!-- Help & Guidance Section -->
                  <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                    {% translate "Help & Guidance" %}
                  </div>
                  <a href="{% url 'questionnaire_guidance' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    {% translate "Questionnaire Guidance" %}
                  </a>
                  
                  <!-- Separator -->
                  <div class="border-t border-gray-200 my-1"></div>
                  
                  <!-- Manage Questionnaire Section -->
                  <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                    {% translate "Manage Questionnaire" %}
                  </div>
                  {% if user.is_authenticated and perms.patientapp.view_patient and perms.promapp.add_patientquestionnaire %}
                  <a href="{% url 'patient_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    {% translate "Assign Questionnaire to Patient" %}
                  </a>
                  {% endif %}
                  
                  {% if user.is_authenticated and perms.promapp.view_questionnaireitemresponse %}
                  <a href="{% url 'questionnaire_export_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    {% translate "Export Questionnaire Responses" %}
                  </a>
                  {% endif %}
                  
                  <!-- Separator -->
                </div>
              </div>
            </div>
            {% endif %}
            {% if user.is_staff %}
            <a href="{% url 'admin:index' %}" class="text-white hover:bg-blue-700 px-3 py-2 rounded-md text-sm font-medium">{% translate "Admin" %}</a>
            {% endif %}
            {% if user.is_authenticated and user.patient %}
            <a href="{% url 'my_questionnaire_list' %}" class="text-white hover:bg-blue-700 px-3 py-2 rounded-md text-sm font-medium">
              {% translate "Complete a Questionnaire" %}
            </a>
            <a href="{% url 'patient_portal' %}" class="text-white hover:bg-blue-700 px-3 py-2 rounded-md text-sm font-medium">
              {% translate "My Portal" %}
            </a>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="hidden md:flex items-center space-x-4">
        <!-- Language Selector -->
        <form action="{% url 'set_language' %}" method="post" class="inline">
          {% csrf_token %}
          <input name="next" type="hidden" value="{{ redirect_to }}">
          <select name="language" onchange="this.form.submit()" class="bg-blue-700 text-white px-2 py-1 rounded text-sm">
            {% get_current_language as CURRENT_LANGUAGE %}
            {% get_available_languages as LANGUAGES %}
            {% for lang_code, lang_name in LANGUAGES %}
              <option value="{{ lang_code }}" {% if lang_code == CURRENT_LANGUAGE %}selected{% endif %}>
                {{ lang_name }}
              </option>
            {% endfor %}
          </select>
        </form>
        
        <!-- Authentication Links -->
        <div class="ml-4 flex items-center">
          {% if user.is_authenticated %}
            <div class="relative group inline-block">
              <button class="text-white hover:bg-blue-700 px-3 py-2 rounded-md text-sm font-medium flex items-center" aria-haspopup="true">
                <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                {{ user.username }}
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
              <div class="absolute right-0 hidden pt-2 group-hover:block z-10">
                <div class="bg-white rounded-md shadow-lg py-1 min-w-max">
                  <!-- Account Management Section -->
                  <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                    {% translate "Account Settings" %}
                  </div>
                  <a href="{% url 'account_email' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <svg class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    {% translate "Change Email" %}
                  </a>
                  <a href="{% url 'account_change_password' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <svg class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3.586l4.293-4.293a1 1 0 011.414 0L10 14l4-4.707A6 6 0 0121 9z" />
                    </svg>
                    {% translate "Change Password" %}
                  </a>
                  <a href="{% url 'socialaccount_connections' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <svg class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                    {% translate "Account Connections" %}
                  </a>
                  
                  <!-- Separator -->
                  <div class="border-t border-gray-200 my-1"></div>
                  
                  <!-- Security Section -->
                  <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                    {% translate "Security" %}
                  </div>
                  <a href="{% url 'mfa_index' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <svg class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    {% translate "Two-Factor Authentication" %}
                  </a>
                  <a href="{% url 'usersessions_list' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                    <svg class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    {% translate "Sessions" %}
                  </a>
                  
                  <!-- Separator -->
                  <div class="border-t border-gray-200 my-1"></div>
                  
                  <form method="post" action="{% url 'account_logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                      <svg class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                      </svg>
                      {% translate "Sign Out" %}
                    </button>
                  </form>
                </div>
              </div>
            </div>
          {% else %}
            <a href="{% url 'account_login' %}" class="text-white hover:bg-blue-700 px-3 py-2 rounded-md text-sm font-medium">{% translate "Login" %}</a>
          {% endif %}
        </div>
      </div>
      <div class="-mr-2 flex md:hidden">
        <button type="button" 
                class="bg-blue-700 inline-flex items-center justify-center p-2 rounded-md text-white hover:bg-blue-800 focus:outline-none" 
                aria-controls="mobile-menu" 
                aria-expanded="false"
                onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
          <span class="sr-only">{% translate "Open main menu" %}</span>
          <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile menu, show/hide based on menu state -->
  <div class="hidden md:hidden" id="mobile-menu">
    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-blue-600">
      <a href="/" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">{% translate "Home" %}</a>
      {% if user.is_authenticated and perms.patientapp.view_patient %}
      <a href="{% url 'patient_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">{% translate "Patients" %}</a>
      {% endif %}
      {% if user.is_authenticated and perms.promapp.view_questionnaire %}
      <div class="py-2">
        <div class="text-white px-3 py-2 font-medium">{% translate "Instruments" %}</div>
        <div class="pl-4 space-y-1">
          <!-- Create Questionnaire Section -->
          <div class="text-white px-3 py-1 text-sm font-medium opacity-75">{% translate "Create Questionnaire" %}</div>
          {% if perms.promapp.view_constructscale %}
          <a href="{% url 'construct_scale_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
            {% translate "Construct Scales" %}
          </a>
          {% endif %}
          {% if perms.promapp.view_compositeconstructscalescoring %}
          <a href="{% url 'composite_construct_scale_scoring_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
            {% translate "Composite Construct Scales" %}
          </a>
          {% endif %}
          {% if perms.promapp.view_item %}
          <a href="{% url 'item_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
            {% translate "Items" %}
          </a>
          {% endif %}
          <a href="{% url 'questionnaire_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
            {% translate "Questionnaires" %}
          </a>
          {% if perms.promapp.view_likertscale %}
          <a href="{% url 'likert_scale_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
            {% translate "Likert Scales" %}
          </a>
          {% endif %}
          {% if perms.promapp.view_rangescale %}
          <a href="{% url 'range_scale_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
            {% translate "Range Scales" %}
          </a>
          {% endif %}
          
          <!-- Separator -->
          <div class="border-t border-blue-500 my-2"></div>
          
          <!-- Help & Guidance Section -->
          <div class="text-white px-3 py-1 text-sm font-medium opacity-75">{% translate "Help & Guidance" %}</div>
          <a href="{% url 'questionnaire_guidance' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
            {% translate "Questionnaire Guidance" %}
          </a>
          
          <!-- Separator -->
          <div class="border-t border-blue-500 my-2"></div>
          
          <!-- Manage Questionnaire Section -->
          <div class="text-white px-3 py-1 text-sm font-medium opacity-75">{% translate "Manage Questionnaire" %}</div>
          {% if user.is_authenticated and perms.patientapp.view_patient and perms.promapp.add_patientquestionnaire %}
          <a href="{% url 'patient_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
            {% translate "Assign Questionnaire to Patient" %}
          </a>
          {% endif %}
          
          {% if user.is_authenticated and perms.promapp.view_questionnaireitemresponse %}
          <a href="{% url 'questionnaire_export_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
            {% translate "Export Questionnaire Responses" %}
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
      {% if user.is_staff %}
      <a href="{% url 'admin:index' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">{% translate "Admin" %}</a>
      {% endif %}
      {% if user.is_authenticated and user.patient %}
      <a href="{% url 'my_questionnaire_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
        {% translate "Complete a Questionnaire" %}
      </a>
      <a href="{% url 'patient_portal' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
        {% translate "My Portal" %}
      </a>
      {% endif %}
      
      <!-- Language Selector (Mobile) -->
      <div class="py-2 px-3">
        <form action="{% url 'set_language' %}" method="post">
          {% csrf_token %}
          <input name="next" type="hidden" value="{{ redirect_to }}">
          <select name="language" onchange="this.form.submit()" class="bg-blue-700 text-white px-2 py-1 rounded w-full">
            {% get_current_language as CURRENT_LANGUAGE %}
            {% get_available_languages as LANGUAGES %}
            {% for lang_code, lang_name in LANGUAGES %}
              <option value="{{ lang_code }}" {% if lang_code == CURRENT_LANGUAGE %}selected{% endif %}>
                {{ lang_name }}
              </option>
            {% endfor %}
          </select>
        </form>
      </div>
      
      {% if user.is_authenticated %}
        <div class="py-2">
          <div class="text-white px-3 py-2 font-medium">{{ user.username }}</div>
          <div class="pl-4 space-y-1">
            <!-- Account Settings Section -->
            <div class="text-white px-3 py-1 text-sm font-medium opacity-75">{% translate "Account Settings" %}</div>
            <a href="{% url 'account_email' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
              {% translate "Change Email" %}
            </a>
            <a href="{% url 'account_change_password' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
              {% translate "Change Password" %}
            </a>
            <a href="{% url 'socialaccount_connections' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
              {% translate "Account Connections" %}
            </a>
            
            <!-- Security Section -->
            <div class="border-t border-blue-500 my-2"></div>
            <div class="text-white px-3 py-1 text-sm font-medium opacity-75">{% translate "Security" %}</div>
            <a href="{% url 'mfa_index' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
              {% translate "Two-Factor Authentication" %}
            </a>
            <a href="{% url 'usersessions_list' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">
              {% translate "Sessions" %}
            </a>
            
            <!-- Separator -->
            <div class="border-t border-blue-500 my-2"></div>
            
            <form method="post" action="{% url 'account_logout' %}">
              {% csrf_token %}
              <button type="submit" class="text-white hover:bg-blue-700 block w-full text-left px-3 py-2 rounded-md text-base font-medium">
                {% translate "Sign Out" %}
              </button>
            </form>
          </div>
        </div>
      {% else %}
        <a href="{% url 'account_login' %}" class="text-white hover:bg-blue-700 block px-3 py-2 rounded-md text-base font-medium">{% translate "Login" %}</a>
      {% endif %}
    </div>
  </div>
</nav>

<script>
  // Add event listener to close mobile menu when clicking outside
  document.addEventListener('click', function(event) {
    const mobileMenu = document.getElementById('mobile-menu');
    const hamburgerButton = document.querySelector('[aria-controls="mobile-menu"]');
    
    if (!mobileMenu.contains(event.target) && !hamburgerButton.contains(event.target)) {
      mobileMenu.classList.add('hidden');
    }
  });
</script>
